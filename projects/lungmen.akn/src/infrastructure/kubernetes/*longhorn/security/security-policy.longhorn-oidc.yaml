---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    security.chezmoi.sh/description: |
      OIDC authentication policy for longhorn HTTPRoute.
      Uses one_factor authentication as this is an infrastructure management interface with controlled access.
      Only requires openid scope for simple authentication without user information leakage.
      Longhorn is a critical storage management interface that requires authentication but not complex authorization.
  name: longhorn-oidc
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: longhorn
  oidc:
    provider:
      issuer: https://sso.chezmoi.sh
    clientID: 605a465f-7fe2-467a-b712-763a5b7fbb49
    clientSecret:
      name: longhorn-oidc-secret
    redirectURL: https://longhorn.lungmen.akn.chezmoi.sh/oauth2/callback
    logoutPath: /logout
    forwardAccessToken: true
    scopes: [openid]
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: longhorn-oidc-secret
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: longhorn-oidc-secret
    creationPolicy: Owner
    template:
      data:
        client-secret: "{{ .client_secret }}"
  data:
    - secretKey: client_secret
      remoteRef:
        key: lungmen.akn/longhorn/auth/oidc-client
        property: client_secret
