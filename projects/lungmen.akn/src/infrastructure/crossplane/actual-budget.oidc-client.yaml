---
apiVersion: tf.upbound.io/v1beta1
kind: Workspace
metadata:
  name: actual-budget-oidc-client
spec:
  forProvider:
    module: |
      resource "pocketid_client" "actual_budget" {
        name          = "Actual Budget"
        callback_urls = [
          "https://budget.chezmoi.sh/openid/callback"
        ]
      }

      output "client_id" {
        description = "The client ID of the Actual Budget OIDC client"
        value       = pocketid_client.actual_budget.id
        sensitive   = false
      }

      output "client_secret" {
        description = "The client secret of the Actual Budget OIDC client"
        value       = pocketid_client.actual_budget.client_secret
        sensitive   = true
      }

      output "issuer_url" {
        description = "The OIDC issuer URL for Pocket ID"
        value       = "https://sso.chezmoi.sh"
        sensitive   = false
      }
    source: Inline
  providerConfigRef:
    name: pocket-id
  writeConnectionSecretToRef:
    name: lungmen.akn-actual-budget-oidc-credentials
    namespace: crossplane-secrets
---
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: lungmen.akn-actual-budget-oidc-credentials
  namespace: crossplane-secrets
spec:
  refreshInterval: 1h
  secretStoreRefs:
    - kind: ClusterSecretStore
      name: vault.chezmoi.sh
  selector:
    secret:
      name: lungmen.akn-actual-budget-oidc-credentials
  template:
    metadata:
      annotations:
        description: Pocket ID OIDC Client credentials for Actual Budget on lungmen.akn
        origin: crossplane
        owner: lungmen.akn
        renewal-process: |
          Remove the actual-budget-oidc-client Workspace then wait ArgoCD to create a new one.
        x-apps: actual-budget
  data:
    - conversionStrategy: None
      match:
        secretKey: client_id
        remoteRef:
          remoteKey: shared/data/third-parties/pocket-id/oidc/lungmen.akn/actual-budget
          property: client_id
    - conversionStrategy: None
      match:
        secretKey: client_secret
        remoteRef:
          remoteKey: shared/data/third-parties/pocket-id/oidc/lungmen.akn/actual-budget
          property: client_secret
    - conversionStrategy: None
      match:
        secretKey: issuer_url
        remoteRef:
          remoteKey: shared/data/third-parties/pocket-id/oidc/lungmen.akn/actual-budget
          property: issuer_url
