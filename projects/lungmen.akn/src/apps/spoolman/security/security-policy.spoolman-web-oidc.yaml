---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    policy.networking.k8s.io/description: |
      OIDC authentication policy for Spoolman web UI HTTPRoute.

      Rationale:
      Spoolman web UI provides access to sensitive 3D printer filament inventory
      and cost tracking data. OIDC authentication via Pocket-ID ensures only
      authorized users can access the web interface while maintaining a seamless
      single sign-on experience across the homelab infrastructure.

      Authentication Method:
      - Uses one_factor authentication level (username + password or passkey)
      - Minimal openid scope to prevent unnecessary data exposure
      - OAuth2 callback handled by Envoy Gateway's native OIDC implementation

      Security Considerations:
      - Web UI does not handle sensitive operations beyond inventory management
      - OIDC provides sufficient security for personal homelab use
      - Logout path allows users to terminate their session properly
  name: spoolman-web-oidc
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: spoolman-web
  oidc:
    provider:
      issuer: https://auth.chezmoi.sh
    clientID: df5160d1-6142-4711-b27e-4bbdce9cdcb8
    clientSecret:
      name: spoolman-oidc-secret
    redirectURL: https://spoolman.chezmoi.sh/oauth2/callback
    logoutPath: /logout
    forwardAccessToken: true
    scopes: [openid]
---
# ExternalSecret for OIDC client secret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: spoolman-oidc-secret
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: spoolman-oidc-secret
    creationPolicy: Owner
    template:
      data:
        client-secret: "{{ .client_secret }}"
  data:
    - secretKey: client_secret
      remoteRef:
        key: lungmen.akn/spoolman/auth/oidc-client
        property: client_secret
