---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    policy.networking.k8s.io/description: |
      API key authentication policy for Spoolman API HTTPRoute.

      Rationale:
      Spoolman API is designed for programmatic access from 3D printer software
      (OctoPrint, Klipper/Moonraker) and automation tools. These systems cannot
      use interactive OIDC authentication and require a simple, stateless
      authentication mechanism. API keys provide the necessary security while
      maintaining compatibility with 3D printer software ecosystems.

      Authentication Method:
      - Envoy Gateway native API key authentication (X-API-Key header)
      - Keys stored securely in Kubernetes secrets managed by External Secrets Operator
      - Multiple keys supported for different tools/users in the same secret
      - Base64-encoded keys for consistent handling

      Security Considerations:
      - API keys are transmitted over HTTPS only (enforced by Envoy Gateway)
      - Each key is independently revocable by removing it from the secret
      - Zero-downtime rotation supported by adding new keys before removing old ones
      - API endpoints are read-only or limited-write operations (inventory updates)
  name: spoolman-api-key
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: spoolman-api
  apiKeyAuth:
    credentialRefs:
      - group: ""
        kind: Secret
        name: spoolman-api-keys
    extractFrom:
      - headers:
          - X-API-Key
---
# ExternalSecret for API keys
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: spoolman-api-keys
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: spoolman-api-keys
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: lungmen.akn/spoolman/auth/api-keys
