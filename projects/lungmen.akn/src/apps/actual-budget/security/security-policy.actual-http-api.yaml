apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    policy.networking.k8s.io/description: |
      API key authentication policy for Actual HTTP API.

      Rationale:
      Actual HTTP API is designed for programmatic access.
      We use Envoy Gateway to handle authentication with multiple API keys,
      and inject a single internal API key for the backend service.

      Authentication Method:
      - Envoy Gateway native API key authentication (X-API-Key header)
      - Keys stored securely in Kubernetes secrets managed by External Secrets Operator
  name: actual-http-api-key
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: actual-budget-api
  apiKeyAuth:
    credentialRefs:
      - group: ""
        kind: Secret
        name: actual-budget-api-client-keys
    extractFrom:
      - headers:
          - X-API-Key
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: actual-budget-api-client-keys
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: actual-budget-api-client-keys
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: lungmen.akn/actual-budget/auth/api-keys
