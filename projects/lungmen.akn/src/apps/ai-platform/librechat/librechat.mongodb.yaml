---
apiVersion: psmdb.percona.com/v1
kind: PerconaServerMongoDB
metadata:
  name: librechat-mongodb
spec:
  crVersion: 1.21.2
  image: percona/percona-server-mongodb:8.0.19
  imagePullPolicy: IfNotPresent

  # -- Unsafe flags
  # Allow 2-node replica set (requires arbiter for quorum)
  unsafeFlags:
    replsetSize: true

  # -- No sharding needed for LibreChat
  sharding:
    enabled: false

  # -- Replica set: 2 data nodes + 1 arbiter
  replsets:
    - name: rs0
      size: 3
      # Allow multiple pods on the same node for 1-node clusters
      affinity:
        antiAffinityTopologyKey: "none"
      # resources:
      #   requests:
      #     memory: 512Mi
      #     cpu: 50m
      #   limits:
      #     memory: 1Gi
      volumeSpec:
        persistentVolumeClaim:
          resources:
            requests:
              storage: 5Gi

      # Arbiter â€” lightweight tie-breaker, no data storage
      arbiter:
        enabled: true
        size: 1
        affinity:
          antiAffinityTopologyKey: "none"
        # resources:
        #   requests:
        #     memory: 128Mi
        #     cpu: 10m
        #   limits:
        #     memory: 256Mi

  # -- Users
  users:
    - name: librechat
      db: admin
      passwordSecretRef:
        name: librechat-database-credentials
        key: mongo_password
      roles:
        - name: readWrite
          db: librechat

  # -- TLS (disabled for troubleshooting)
  tls:
    mode: disabled

  # -- Backup (disabled for now)
  backup:
    enabled: false
    image: percona/percona-backup-mongodb:2.8.0
