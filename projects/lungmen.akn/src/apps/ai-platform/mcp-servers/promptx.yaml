# MCPServer for PromptX (PromptX runs an HTTP MCP on port 5203).
# This manifest deploys the PromptX MCP server as a ToolHive MCPServer.
# NOTE: This does NOT create any external HTTPRoute; the service is only
# reachable internally via the ToolHive proxy (no external exposure).
#
# When the ToolHive operator provisions the proxy, clients in-cluster can
# reach the server at: http://mcp-promptx-proxy.open-webui.svc.cluster.local:8080/
#
apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPServer
metadata:
  name: promptx
  namespace: open-webui
  labels:
    app.kubernetes.io/name: promptx
    app.kubernetes.io/managed-by: toolhive-operator
  annotations:
    description: "PromptX MCP server - local/internal only. See projects/lungmen.akn/src/apps/ai-platform/docs for details."
spec:
  # Public image referenced from PromptX documentation (container image repo).
  image: deepracticexs/promptx:latest

  # Use HTTP transport — PromptX exposes an HTTP MCP endpoint (streamable HTTP).
  transport: streamable-http

  # The ToolHive proxy will listen on this port (internal to the proxy service).
  proxyPort: 8080

  # PromptX's MCP server listens on port 5203 inside the container.
  # ToolHive will forward requests from the proxy to this port.
  mcpPort: 5203

  # No external secrets required by default. If you later choose to add persistent
  # configuration or credentials, inject them using the `secrets:` stanza here.
  #
  # Example (commented):
  # secrets:
  #   - name: promptx-config-secret
  #     key: CONFIG_JSON
  #     targetEnvName: PROMPTX_CONFIG_JSON

  # Plaintext environment variables (none required by default).
  env: []

  # Pod resource sizing — tuned for a small homelab instance. Adjust as needed.
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "300m"
      memory: "512Mi"

  # Ensure the runtime directory exists and has correct ownership. Some PromptX
  # images expect to write to /home/node/.promptx; if the image runs as non-root
  # the directory must be writable. We add an emptyDir and an initContainer that
  # creates the directory and chowns it to UID 1000 (node).
  podTemplateSpec:
    spec:
      containers:
        - name: mcp
          volumeMounts:
            - name: promptx-data
              mountPath: /home/node/.promptx
      volumes:
        - name: promptx-data
          emptyDir: {}
