---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  labels:
    app.kubernetes.io/component: database
    app.kubernetes.io/instance: n8n-database
  name: n8n-database
spec:
  bootstrap:
    recovery:
      source: 2026-01-15T08:13:48.686Z
  description: PostgreSQL database dedicated to n8n
  enablePDB: false
  imageCatalogRef:
    apiGroup: postgresql.cnpg.io
    kind: ClusterImageCatalog
    name: default
    major: 18
  instances: 1
  managed:
    roles:
      - name: n8n
        connectionLimit: -1
        comment: PostgreSQL role for n8n
        ensure: present
        inherit: true
        login: true
        passwordSecret:
          name: n8n-database-n8n
  plugins:
    - enabled: true
      isWALArchiver: true
      name: barman-cloud.cloudnative-pg.io
      parameters:
        barmanObjectName: selfhosted
        serverName: 01KJ3V8C8SVZMKMHFRJ8W2FR2D # 2026-02-22T23:34:19.166Z
  postgresql:
    parameters:
      # Limit WAL retention to avoid DB crash due to storage bloat
      max_slot_wal_keep_size: 900MB
      max_wal_size: 100MB
  storage:
    size: 1Gi
  walStorage:
    size: 1Gi

  externalClusters:
    - name: 2026-01-15T08:13:48.686Z
      plugin:
        enabled: true
        isWALArchiver: false
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: selfhosted
          serverName: 01KF0BFJ8E817KVKXB34G81G2H

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: n8n-database-n8n
spec:
  dataFrom:
    - extract:
        key: lungmen.akn/n8n/database/postgresql
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault.chezmoi.sh
  target:
    template:
      data:
        username: n8n
        password: "{{ .password }}"
        uri: "postgres://n8n:{{ .password }}@n8n-database-rw:5432/n8n"
