vars: {
  d2-config: {
    layout-engine: elk
    sketch: true
  }
}

...@../../docs/assets/d2/architecture-styles.d2

explanation: |md
  # lungmen.akn Architecture

  This document describes the architecture \
  of the lungmen.akn platform in a visual way \
  with all the components and how they \
  interact with each other.

  lungmen.akn serves as the home applications \
  cluster, providing media, life management, \
  and personal productivity services for \
  the homelab infrastructure.
| {
  near: top-left
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                              External Objects                              │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   These objects represent resources external to the lungmen.akn platform   │
# │   but which interact with or are used by it.                               │
# │   They include networks, hardware, or third-party services                 │
# │   essential for the proper functioning, connectivity, security,            │
# │   or management of the platform.                                           │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Networks

internet: {class: network}
localnet: {class: network}
tailnet: {
  class: network
  tooltip: Tailnet - Mesh VPN Network
}


# ──────────────────────────────────────────────────────────────────────────────
# Hardware & Infrastructure

udm-pro: {
  class: hardware
  icon: assets/icons/hardware/unifi.svg
  tooltip: UniFi Dream Machine Pro - Gateway & Network Controller
}


# ──────────────────────────────────────────────────────────────────────────────
# External Clusters

amiya·akn: {
  class: [application]
  label: amiya·akn
  icon: ../amiya.akn/assets/logo.svg
  tooltip: Mission-critical services cluster (SSO, Secrets, etc.)

  pocket-id {
    class: [application]
    icon: assets/icons/apps/pocket-id.svg
    label: auth.chezmoi.sh
    link: https://pocket-id.org/
    tooltip: Pocket-ID is an open-source identity and access management solution based only on passkeys.
  }

  openbao {
    class: [application]
    icon: assets/icons/apps/openbao.svg
    label: vault.chezmoi.sh
    link: https://openbao.org/
    tooltip: OpenBao is an open-source, community-driven fork of Vault managed by the Linux Foundation.
  }
}

# ──────────────────────────────────────────────────────────────────────────────
# Hardware & Infrastructure

nas: {
  class: namespace
  label: TrueNAS Scale
  icon: assets/icons/hardware/truenas-scale.svg
  tooltip: Home Network Attached Storage (NAS)

  minio: {
    class: [application]
    label: MinIO
    icon: assets/icons/apps/minio.svg
    link: https://min.io/
    tooltip: MinIO is a high-performance, distributed object storage system.
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                            lungmen.akn Platform                            │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This namespace contains all the components of the lungmen.akn platform,  │
# │   serving as the home applications cluster providing media, life           │
# │   management, and personal productivity services for the homelab.          │
# ╰────────────────────────────────────────────────────────────────────────────╯

lungmen·akn: {
  icon: assets/logo.svg
  style.fill-pattern: none

  system: {class: namespace}
  media: {class: namespace}
  life: {class: namespace}
  others: {class: namespace}

  # ────────────────────────────────────────────────────────────────────────────
  # System Components

  system.cert-manager: {
    class: [application-system]
    label: Cert-Manager
    icon: assets/icons/system/cert-manager.svg
    link: https://cert-manager.io/
    tooltip: Cert-Manager is a Kubernetes controller that automates the management and issuance of TLS certificates.
  }

  system.cilium: {
    class: [application-system]
    label: Cilium
    icon: assets/icons/system/cilium.svg
    link: https://cilium.io/
    tooltip: Cilium is a networking, observability, and security solution with an eBPF-based dataplane.
  }

  system.cloudnativepg: {
    class: [application-system]
    label: CloudNativePG
    icon: assets/icons/system/cloudnativepg.svg
    link: https://cloudnativepg.io/
    tooltip: CloudNativePG is a comprehensive platform designed to seamlessly manage PostgreSQL databases within Kubernetes environments.
  }

  system.envoy-gateway: {
    class: [application-system]
    label: Envoy Gateway
    icon: assets/icons/system/envoy-gateway.svg
    link: https://gateway.envoyproxy.io/
    tooltip: Envoy Gateway is a Kubernetes-native API Gateway powered by Envoy Proxy with support for Gateway API.
  }

  system.external-dns: {
    class: [application-system]
    label: ExternalDNS
    icon: assets/icons/system/external-dns.png
    link: https://github.com/kubernetes-sigs/external-dns
    tooltip: ExternalDNS configures DNS records automatically for exposed services.
  }

  system.external-secrets: {
    class: [application-system]
    label: External-Secret
    icon: assets/icons/system/external-secret.svg
    link: https://external-secrets.io/
    tooltip: External-Secret is a Kubernetes controller that allows you to use external secret management systems.
  }

  system.cloudnativepg: {
    class: [application-system]
    label: CloudNativePG
    icon: assets/icons/system/cloudnativepg.svg
    link: https://cloudnativepg.io/
    tooltip: CloudNativePG is a comprehensive platform designed to seamlessly manage PostgreSQL databases within Kubernetes environments.
  }

  system.longhorn: {
    class: [application-system]
    label: Longhorn
    icon: assets/icons/system/longhorn.svg
    link: https://longhorn.io/
    tooltip: Longhorn is a lightweight, reliable, and powerful distributed block storage system for Kubernetes.
  }

  system.tailscale: {
    class: [application-system]
    label: Tailscale
    icon: assets/icons/system/tailscale.svg
    link: https://tailscale.com/
    tooltip: TailScale is a mesh VPN that makes it easy to connect your devices, wherever they are.
  }

  # ────────────────────────────────────────────────────────────────────────────
  # Media Components
  
  media.immich-stack: {
    class: [namespace]
    label: Immich Stack
    tooltip: Immich photo and video management stack with PostgreSQL backend and Redis cache

    immich: {
      class: [application]
      label: Immich
      icon: assets/icons/apps/immich.svg
      link: https://immich.app/
      tooltip: High-performance self-hosted photo and video management solution with mobile app support.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Immich with VectorChord extension, managed by CloudNative-PG operator with automated backups to S3.
    }

    redis: {
      class: [application-datastore]
      label: Redis
      icon: assets/icons/apps/redis.svg
      link: https://redis.io/
      tooltip: Redis cache for improved Immich performance and background task processing.
    }
  }

  media.jellyfin: {
    class: [application]
    label: Jellyfin
    icon: assets/icons/apps/jellyfin.svg
    link: https://jellyfin.org/
    tooltip: Volunteer-built media solution that puts you in control of your media.
  }

  media.jellyseerr-stack: {
    class: [namespace]
    label: Jellyseerr Stack
    tooltip: Jellyseerr media request management stack with PostgreSQL backend

    jellyseerr: {
      class: [application]
      label: Jellyseerr
      icon: assets/icons/apps/jellyseerr.svg
      link: https://github.com/Fallenbagel/jellyseerr
      tooltip: Free and open source software application for managing requests for media libraries.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Jellyseerr, managed by CloudNative-PG operator with automated backups to S3.
    }
  }

  # ────────────────────────────────────────────────────────────────────────────
  # Life Management Components
  
  life.actual-budget: {
    class: [application]
    label: Actual Budget
    icon: assets/icons/apps/actual-budget.png
    link: https://actualbudget.com/
    tooltip: Personal finance app that helps you track your spending and save money.
  }

  life.paperless-stack: {
    class: [namespace]
    label: Paperless Stack
    tooltip: Paperless document management stack with PostgreSQL backend and Redis cache

    paperless: {
      class: [application]
      label: Paperless-ngx
      icon: assets/icons/apps/paperless.svg
      link: https://docs.paperless-ngx.com/
      tooltip: Document management system to store, search and share documents.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Paperless, managed by CloudNative-PG operator with automated backups to S3.
    }

    redis: {
      class: [application-datastore]
      label: Redis
      icon: assets/icons/apps/redis.svg
      link: https://redis.io/
      tooltip: Redis cache for improved Paperless performance and background task processing.
    }
  }

  # ────────────────────────────────────────────────────────────────────────────
  # Other Components
  
  others.atuin-stack: {
    class: [namespace]
    label: Atuin Stack
    tooltip: Atuin shell history sync stack with PostgreSQL backend

    atuin: {
      class: [application]
      label: Atuin
      icon: assets/icons/apps/atuin.svg
      link: https://docs.atuin.sh/
      tooltip: Encrypted shell history sync, storing all your shell commands in one place.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Atuin, managed by CloudNative-PG operator with automated backups to S3.
    }
  }

  others.linkding-stack: {
    class: [namespace]
    label: Linkding Stack
    tooltip: Linkding bookmarking stack with PostgreSQL backend

    linkding: {
      class: [application]
      label: Linkding
      icon: assets/icons/apps/linkding.svg
      link: https://github.com/sissbruecker/linkding
      tooltip: Self-hosted bookmarking and link aggregation service with OIDC authentication.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Linkding, managed by CloudNative-PG operator with automated backups to S3.
    }
  }

  others.silverbullet: {
    class: [application]
    label: Silverbullet
    icon: assets/icons/apps/silverbullet.png
    link: https://silverbullet.md/
    tooltip: Personal productivity platform and wiki built on Markdown with Lua scripting capabilities.
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                                Connections                                 │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the various connections within the lungmen.akn    │
# │   platform and its interactions with external systems.                     │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Network to Platform Flow

localnet -> lungmen·akn.system.envoy-gateway: |md
    HTTP (80)
    HTTPS (443)
  |

tailnet -> lungmen·akn.system.tailscale: {class: [connect-vpn-backbone]}


# ──────────────────────────────────────────────────────────────────────────────
# System Connections

lungmen·akn.system.cert-manager -> internet: "ACME certificate validation (443)" {class: [connect-to-internet;]}

lungmen·akn.system.external-dns -> udm-pro: "Automated DNS record management (443)" {}

lungmen·akn.system.external-secrets -> amiya·akn.openbao: "Secure secrets retrieval from vault (443)" {}

lungmen·akn.system.tailscale -> internet: "VPN tunnel establishment (443)" {class: [connect-to-internet;]}


# ──────────────────────────────────────────────────────────────────────────────
# Media Services Flow

lungmen·akn.media.immich-stack.immich -> amiya·akn.pocket-id: "SSO authentication (443)" {}
lungmen·akn.media.immich-stack.immich -> lungmen·akn.media.immich-stack.postgresql: "Database operations (5432)" {}
lungmen·akn.media.immich-stack.immich -> lungmen·akn.media.immich-stack.redis: "Cache operations (6379)" {}
lungmen·akn.media.immich-stack.immich <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (2283)" {}
lungmen·akn.media.immich-stack.postgresql -> nas.minio: "Database backups (S3)" {}
lungmen·akn.media.immich-stack.postgresql <- lungmen·akn.system.cloudnativepg: "Database management" {class: [connect-management]}

lungmen·akn.media.jellyfin -> amiya·akn.pocket-id: "SSO authentication (443)" {}
lungmen·akn.media.jellyfin -> internet: "Metadata and external content fetching (443)" {class: [connect-to-internet]}
lungmen·akn.media.jellyfin <- lungmen·akn.media.jellyseerr-stack.jellyseerr: "Media library API access (8096)" {}
lungmen·akn.media.jellyfin <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (8096)" {}

lungmen·akn.media.jellyseerr-stack.jellyseerr -> lungmen·akn.media.jellyseerr-stack.postgresql: "Database operations (5432)" {}
lungmen·akn.media.jellyseerr-stack.jellyseerr -> internet: "External media database queries (443)" {class: [connect-to-internet]}
lungmen·akn.media.jellyseerr-stack.jellyseerr <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (5055)" {}
lungmen·akn.media.jellyseerr-stack.postgresql -> nas.minio: "Database backups (S3)" {}
lungmen·akn.media.jellyseerr-stack.postgresql <- lungmen·akn.system.cloudnativepg: "Database management" {class: [connect-management]}


# ──────────────────────────────────────────────────────────────────────────────
# Life Management Flow

lungmen·akn.life.actual-budget -> amiya·akn.pocket-id: "SSO authentication (443)" {}
lungmen·akn.life.actual-budget <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (5006)" {}

lungmen·akn.life.paperless-stack.paperless -> amiya·akn.pocket-id: "SSO authentication (443)" {}
lungmen·akn.life.paperless-stack.paperless -> lungmen·akn.life.paperless-stack.postgresql: "Database operations (5432)" {}
lungmen·akn.life.paperless-stack.paperless -> lungmen·akn.life.paperless-stack.redis: "Cache operations (6379)" {}
lungmen·akn.life.paperless-stack.paperless <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (8000)" {}
lungmen·akn.life.paperless-stack.paperless -> internet: "IMAP email access (993)" {class: [connect-to-internet]}
lungmen·akn.life.paperless-stack.postgresql -> nas.minio: "Database backups (S3)" {}
lungmen·akn.life.paperless-stack.postgresql <- lungmen·akn.system.cloudnativepg: "Database management" {class: [connect-management]}


# ──────────────────────────────────────────────────────────────────────────────
# Other Services Flow

lungmen·akn.others.atuin-stack.atuin -> lungmen·akn.others.atuin-stack.postgresql: "Database operations (5432)" {}
lungmen·akn.others.atuin-stack.atuin <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (8888)" {}
lungmen·akn.others.atuin-stack.atuin <- lungmen·akn.system.tailscale: "VPN access (8888)" {class: [connect-vpn-backbone]}
lungmen·akn.others.atuin-stack.postgresql -> nas.minio: "Database backups (S3)" {}
lungmen·akn.others.atuin-stack.postgresql <- lungmen·akn.system.cloudnativepg: "Database management" {class: [connect-management]}

lungmen·akn.others.linkding-stack.linkding -> amiya·akn.pocket-id: "SSO authentication (443)" {}
lungmen·akn.others.linkding-stack.linkding -> lungmen·akn.others.linkding-stack.postgresql: "Database operations (5432)" {}
lungmen·akn.others.linkding-stack.linkding -> internet: "Website information fetching (443)" {class: [connect-to-internet]}
lungmen·akn.others.linkding-stack.linkding <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (9090)" {}
lungmen·akn.others.linkding-stack.postgresql -> nas.minio: "Database backups (S3)" {}
lungmen·akn.others.linkding-stack.postgresql <- lungmen·akn.system.cloudnativepg: "Database management" {class: [connect-management]}

lungmen·akn.others.silverbullet -> internet: "Plug downloads (443)" {class: [connect-to-internet]}
lungmen·akn.others.silverbullet <- lungmen·akn.system.envoy-gateway: "HTTP traffic proxy (3000)" {}
lungmen·akn.others.silverbullet <- lungmen·akn.system.tailscale: "VPN access (3000)" {class: [connect-vpn-backbone]}


# ──────────────────────────────────────────────────────────────────────────────
# Storage and Backup Connections

lungmen·akn.system.longhorn -> nas.minio: "Volume backups (S3)" {}
