# ------------------------------------------------------------------------------------------------
# üîß D2 Configuration
# ------------------------------------------------------------------------------------------------

explanation: |md
  # Lungmen Architecture

  This document describes the architecture \
  of the Lungmen platform in a visual way \
  with all the components and how they \
  interact with each other.
| {
  near: top-left
}

...@../../docs/assets/d2/architecture-styles.d2


# ------------------------------------------------------------------------------------------------
# üåê Networks definition
# ------------------------------------------------------------------------------------------------

internet: {class: [network]}
localnet: {class: [network]}
tailnet: {
  class: [network]
  tooltip: Tailnet - Mesh VPN Network
}


# ------------------------------------------------------------------------------------------------
# üñ•Ô∏è Hardware & Infrastructure definition
# ------------------------------------------------------------------------------------------------

UDM-Pro: {
  class: [hardware]
  icon: assets/icons/hardware/unifi.svg
  tooltip: UniFi Dream Machine Pro - Gateway & Network Controller
}


# ------------------------------------------------------------------------------------------------
# üì¶ Components definition
# ------------------------------------------------------------------------------------------------

lungmen: {
  label: ‚ò∏ lungmen.akn.chezmoi.sh
  style.fill-pattern: none

  system: {class: [namespace]}
  media: {class: [namespace]}
  life: {class: [namespace]}
  others: {class: [namespace]}

  # ‚öôÔ∏è System Components
  system.Cilium: {
    class: [application-system; undeployed]
    icon: assets/icons/system/cilium.svg
    link: https://cilium.io/
    tooltip: Advanced networking, security policies, and observability for Kubernetes clusters.
  }

  system.cert-manager: {
    class: [application-system; undeployed]
    icon: assets/icons/system/cert-manager.svg
    link: https://cert-manager.io/
    tooltip: Automatic provisioning and management of TLS certificates in Kubernetes.
  }

  system.External-DNS: {
    class: [application-system; undeployed]
    icon: assets/icons/system/external-dns.png
    link: https://github.com/kubernetes-sigs/external-dns
    tooltip: Automatically configures DNS records for Kubernetes services.
  }

  system.External-Secrets: {
    class: [application-system; undeployed]
    icon: assets/icons/system/external-secret.svg
    link: https://external-secrets.io/
    tooltip: Kubernetes operator that integrates external secret management systems.
  }

  system.envoy-gateway: {
    class: [application-system; undeployed]
    icon: assets/icons/system/envoy-gateway.svg
    link: https://gateway.envoyproxy.io/
    tooltip: Kubernetes-native API Gateway powered by Envoy Proxy with support for Gateway API.
  }

  system.Tailscale: {
    class: [application-system; undeployed]
    icon: assets/icons/system/tailscale.svg
    link: https://tailscale.com/
    tooltip: Zero-config VPN mesh for secure remote access to the entire platform.
  }

  system.Longhorn: {
    class: [application-system; undeployed]
    icon: assets/icons/system/longhorn.svg
    link: https://longhorn.io/
    tooltip: Lightweight, reliable, and powerful distributed block storage system for Kubernetes.
  }

  system.CloudNativePG: {
    class: [application-system; undeployed]
    icon: assets/icons/system/cloudnativepg.svg
    link: https://cloudnativepg.io/
    tooltip: Comprehensive platform designed to seamlessly manage PostgreSQL databases within Kubernetes environments.
  }

  # üì∫ Media Components
  media.Jellyfin: {
    class: [application; undeployed]
    icon: assets/icons/apps/jellyfin.svg
    link: https://jellyfin.org/
    tooltip: Volunteer-built media solution that puts you in control of your media.
  }

  media.Jellyseerr: {
    class: [application; undeployed]
    icon: assets/icons/apps/jellyseerr.svg
    link: https://github.com/Fallenbagel/jellyseerr
    tooltip: Free and open source software application for managing requests for media libraries.
  }

  # üè† Life Management Components
  life.Actual-Budget: {
    class: [application; undeployed]
    icon: assets/icons/apps/actual-budget.png
    link: https://actualbudget.com/
    tooltip: Personal finance app that helps you track your spending and save money.
  }

  life.Paperless: {
    class: [application; undeployed]
    icon: assets/icons/apps/paperless.svg
    link: https://docs.paperless-ngx.com/
    tooltip: Document management system to store, search and share documents.
  }

  # üì¶ Other Components
  others.Linkding: {
    class: [application; undeployed]
    icon: assets/icons/apps/linkding.svg
    link: https://github.com/sissbruecker/linkding
    tooltip: Self-hosted bookmarking and link aggregation service.
  }

  others.Atuin: {
    class: [application; undeployed]
    icon: assets/icons/apps/atuin.svg
    link: https://docs.atuin.sh/
    tooltip: Encrypted shell history sync, storing all your shell commands in one place.
  }

  others.TaskChampion: {
    class: [application; undeployed]
    icon: assets/icons/apps/taskwarrior.png
    link: https://github.com/GothenburgBitFactory/taskchampion-sync-server
    tooltip: Sync server for TaskWarrior, a modern task management system.
  }
}


# ------------------------------------------------------------------------------------------------
# üîó Connections
# ------------------------------------------------------------------------------------------------

# System connections
lungmen.system.Tailscale <- tailnet: {class: [connect-from-vpn-backbone; undeployed]}
lungmen.system.envoy-gateway <- localnet: {
  source-arrowhead: |md
    HTTP (80)
    HTTPS (443)
  |
  class: undeployed
}
lungmen.system.cert-manager -> internet: HTTPS (443) {class: [connect-to-internet; undeployed]}
lungmen.system.External-DNS -> UDM-Pro: DNS updates {class: undeployed}

# Media services connections
lungmen.media.Jellyfin <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (8096); class: undeployed }
lungmen.media.Jellyfin <- lungmen.system.Tailscale: { source-arrowhead: HTTP (8096); class: [connect-from-vpn; undeployed] }
lungmen.media.Jellyfin <- lungmen.media.Jellyseerr: { source-arrowhead: HTTP (8096); class: undeployed }
lungmen.media.Jellyseerr <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (5055); class: undeployed }
lungmen.media.Jellyseerr <- lungmen.system.Tailscale: { source-arrowhead: HTTP (5055); class: [connect-from-vpn; undeployed] }

# Life management connections
lungmen.life.Actual-Budget <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (5006); class: undeployed }
lungmen.life.Actual-Budget <- lungmen.system.Tailscale: { source-arrowhead: HTTP (5006); class: [connect-from-vpn; undeployed] }
lungmen.life.Paperless <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (8000); class: undeployed }
lungmen.life.Paperless <- lungmen.system.Tailscale: { source-arrowhead: HTTP (8000); class: [connect-from-vpn; undeployed] }

# Other services connections
lungmen.others.Linkding <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (9090); class: undeployed }
lungmen.others.Linkding <- lungmen.system.Tailscale: { source-arrowhead: HTTP (9090); class: [connect-from-vpn; undeployed] }

lungmen.others.Atuin <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (8888); class: undeployed }
lungmen.others.Atuin <- lungmen.system.Tailscale: { source-arrowhead: HTTP (8888); class: [connect-from-vpn; undeployed] }

lungmen.others.TaskChampion <- lungmen.system.envoy-gateway: { source-arrowhead: HTTP (8080); class: undeployed }
lungmen.others.TaskChampion <- lungmen.system.Tailscale: { source-arrowhead: HTTP (8080); class: [connect-from-vpn; undeployed] } 
