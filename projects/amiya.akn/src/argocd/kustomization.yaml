---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd

resources:
  # Configure ArgoCD
  - argocd.appprojects.yaml
  - argocd.httproute.yaml
  - argocd.ingress.yaml
  - argocd.oidc-credentials.externalsecret.yaml
  - argocd.ts-secrets.externalsecret.yaml

  # Install Argotails that manages all Tailscale clusters
  # secrets based on Tailscale's devices
  - https://github.com/chezmoidotsh/argotails.git//deploy/manifests/default?ref=v0.1.12
  - argotails.ts-secrets.externalsecret.yaml

generators:
  - # Because ArgoCD needs to be independent from Vault in order to bootstrap
    # the rest of the cluster, we store some secrets directly in SOPS-encrypted
    # Secrets (SOPS age encryption and Github Application secrets).
    |-
    apiVersion: viaduct.ai/v1
    kind: ksops
    metadata:
      name: ksops
      annotations:
        config.kubernetes.io/function: |
          exec:
            path: ksops
    files:
      - argocd.github.secrets.yaml
      - argocd.sops.secrets.yaml

helmCharts:
  - name: argo-cd
    repo: https://argoproj.github.io/argo-helm
    releaseName: argocd
    version: 9.4.3
    valuesFile: argocd.helmvalues/default.yaml
    additionalValuesFiles:
      - argocd.helmvalues/hardened.yaml
      - argocd.helmvalues/extensions.yaml
      - argocd.helmvalues/addon:crossplane.yaml
      - argocd.helmvalues/addon:ksops.yaml
      - argocd.helmvalues/addon:tailscale.yaml

patches:
  - patch: |
      - op: replace
        path: /spec/template/spec/containers/0/args/2
        value: --ts.device-filter=kubernetes-remote-cluster
      - op: replace
        path: /spec/template/spec/containers/0/env/0/value
        value: tail831c5d.ts.net
    target:
      name: argotails
      kind: Deployment

  - # Configure Argotails to create a Tailscale service for
    # each remote cluster
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --service.create
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --service.proxy-class=remote-cluster
    target:
      name: argotails
      kind: Deployment

images:
  - name: quay.io/argoproj/argocd
    # newTag is omitted to always use the image defined by the Helm chart
  - name: public.ecr.aws/docker/library/redis
    # newTag is omitted to always use the image defined by the Helm chart
  - name: ghcr.io/oliver006/redis_exporter
    # newTag is omitted to always use the image defined by the Helm chart
  - name: quay.io/argoprojlabs/argocd-extension-installer
    # newTag is omitted to always use the image defined by the Helm chart
