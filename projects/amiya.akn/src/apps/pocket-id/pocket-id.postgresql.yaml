---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  labels:
    app.kubernetes.io/component: database
    app.kubernetes.io/instance: pocket-id-database
  name: pocket-id-database
spec:
  bootstrap:
    initdb:
      database: pocket_id
      owner: pocket_id
      secret:
        name: pocket-id-database-pocket-id
    # recovery:
    #   source: 0001-01-01T00:00:00.000Z
  description: PostgreSQL database dedicated to pocket-id
  enablePDB: false
  imageCatalogRef:
    apiGroup: postgresql.cnpg.io
    kind: ClusterImageCatalog
    name: default
    major: 17
  instances: 2
  managed:
    roles:
      - name: pocket_id
        connectionLimit: -1
        comment: PostgreSQL role for pocket_id
        ensure: present
        inherit: true
        login: true
        passwordSecret:
          name: pocket-id-database-pocket-id
  plugins:
    - enabled: true
      isWALArchiver: true
      name: barman-cloud.cloudnative-pg.io
      parameters:
        barmanObjectName: selfhosted
        serverName: 01KEPA38352GYQHNKTFYPA4HE1 # 2026-01-11T10:37:12.165Z
  postgresql:
    parameters:
      # Limit WAL retention to avoid DB crash due to storage bloat
      max_slot_wal_keep_size: 900MB
      max_wal_size: 100MB
  storage:
    size: 250Mi
  walStorage:
    size: 1Gi

  # Restore all data from legacy cluster present in the sso namespace
  # externalClusters:
  #   NOTE: Uncomment and adjust the following to restore from a specific backup
  #   - name: 0001-01-01T00:00:00.000Z
  #     plugin:
  #       enabled: true
  #       isWALArchiver: false
  #       name: barman-cloud.cloudnative-pg.io
  #       parameters:
  #         barmanObjectName: selfhosted
  #         serverName: ??? # Fill in appropriate server name
