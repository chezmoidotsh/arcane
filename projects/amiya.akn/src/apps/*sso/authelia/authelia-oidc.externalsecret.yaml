---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authelia-oidc
spec:
  data:
    # Longhorn OIDC clients
    - secretKey: oidc.client.longhorn-amiya.akn
      remoteRef:
        key: amiya.akn/longhorn/auth/oidc-client
    - secretKey: oidc.client.longhorn-lungmen.akn
      remoteRef:
        key: lungmen.akn/longhorn/auth/oidc-client

    # OpenBao OIDC client
    - secretKey: oidc.client.openbao
      remoteRef:
        key: amiya.akn/openbao/auth/oidc-client
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault.chezmoi.sh
  target:
    name: authelia-oidc
    template:
      engineVersion: v2
      templateFrom:
        - target: Data
          # NOTE: this template is required to remove any key that are not handled by Authelia
          literal: |
            {{- range $client, $config := . }}
            {{- $client }}: |- {{ pick ($config | fromJson) "access_token_encrypted_response_alg" "access_token_encrypted_response_enc" "access_token_signed_response_alg" "audience" "authorization_encrypted_response_alg" "authorization_encrypted_response_enc" "authorization_signed_response_alg" "authorization_policy" "claims_policy" "client_id" "client_name" "client_secret" "consent_mode" "grant_types" "id_token_encrypted_response_alg" "id_token_encrypted_response_enc" "id_token_signed_response_alg" "introspection_encrypted_response_alg" "introspection_encrypted_response_enc" "introspection_signed_response_alg" "introspection_endpoint_auth_method" "introspection_endpoint_auth_signing_alg" "jwks" "jwks_uri" "key_id" "use" "algorithm" "key" "certificate_chain" "pkce_challenge_method" "pre_configured_consent_duration" "public" "pushed_authorization_request_endpoint_auth_method" "pushed_authorization_request_endpoint_auth_signing_alg" "redirect_uris" "request_object_encryption_alg" "request_object_encryption_enc" "request_object_signing_alg" "request_uris" "requested_audience_mode" "response_modes" "response_types" "revocation_endpoint_auth_method" "revocation_endpoint_auth_signing_alg" "require_pkce" "require_pushed_authorization_requests" "scopes" "sector_identifier_uri" "token_endpoint_auth_method" "token_endpoint_auth_signing_alg" "lifespan" | toYaml | nindent 2 }}
            {{ end }}
