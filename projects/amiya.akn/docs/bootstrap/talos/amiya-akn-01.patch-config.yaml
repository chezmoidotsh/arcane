machine:
  # -- Node configuration
  type: controlplane
  network:
    hostname: amiya-akn-01

  # -- Machine installation
  install:
    # enabled extentions:
    # - siderolabs/intel-ucode
    # - siderolabs/iscsi-tools
    # - siderolabs/thunderbolt
    # - siderolabs/util-linux-tools
    image: factory.talos.dev/installer-secureboot/09618ac37329fe4ba876873eaa598360a73d105a207021c4b50a1c444a033e0d:v1.10.6
    diskSelector:
      size: ">= 256GB"
    wipe: true

  # -- Custom configuration (enable user namespaces)
  kubelet:
    clusterDNS:
      - 10.96.0.10
    extraArgs:
      rotate-server-certificates: true # NOTE: This is required for Metrics Server
    extraConfig:
      featureGates:
        UserNamespacesSupport: true
        UserNamespacesPodSecurityStandards: true
  sysctls:
    user.max_user_namespaces: "11255"

  # Features describe individual Talos features that can be switched on or off.
  features:
    # Configures host DNS caching resolver.
    hostDNS:
      enabled: true # Enable host DNS caching resolver.
      forwardKubeDNSToHost: true # Use the host DNS resolver as upstream for Kubernetes CoreDNS pods.
      resolveMemberNames: true # Enable DNS resolution of member names in Kubernetes.
    imageCache:
      localEnabled: false # Disable local image cache.

cluster:
  allowSchedulingOnControlPlanes: true

  # -- CoreDNS configuration
  coreDNS:
    disabled: true # TalosOS CoreDNS is disabled to allow us to use a custom CoreDNS configuration.

  # -- Network configuration (disable CNI to allow Cilium to work)
  network:
    cni:
      name: custom
      urls:
        - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/projects/amiya.akn/docs/bootstrap/talos/manifests/cilium~1.17.3.yaml
  proxy:
    disabled: true

  # -- Custom configuration (enable user namespaces)
  apiServer:
    extraArgs:
      feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true

  # -- Install extra components
  extraManifests:
    # -- CoreDNS configuration override
    - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/coredns+tailscale/1.12.3.yaml

    # -- Metrics Server
    - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/kubelet-serving-cert-approver/0.9.1.yaml
    - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/metrics-server/0.7.2.yaml
