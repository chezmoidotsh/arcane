vars: {
  d2-config: {
    layout-engine: elk
    sketch: true
  }
}

...@../../docs/assets/d2/architecture-styles.d2

explanation: |md
  # amiya.akn Architecture

  This document describes the architecture \
  of the amiya.akn platform in a visual way \
  with all the components and how they \
  interact with each other.
| {
  near: top-left
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                              External Objects                              │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   These objects represent resources external to the amiya.akn platform     │
# │   but which interact with or are used by it.                               │
# │   They include networks, hardware, or third-party services                 │
# │   essential for the proper functioning, connectivity, security,            │
# │   or management of the platform.                                           │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Networks

internet: {class: network}
localnet: {class: network}
tailnet: {
  class: network
  tooltip: Tailnet - Mesh VPN Network
}

# ──────────────────────────────────────────────────────────────────────────────
# 3rd Party Services

aws.ses {
  class: [application]
  label: AWS SES
  icon: assets/icons/platform/aws.svg
  link: https://aws.amazon.com/ses/
  tooltip: Amazon Simple Email Service (SES).
}

pocket-id: {
  class: [application]
  label: Pocket ID
  icon: assets/icons/apps/pocket-id.svg
  link: https://pocket-id.org/
  tooltip: Pocket ID is a secure identity management service.
}

# ──────────────────────────────────────────────────────────────────────────────
# Hardware & Infrastructure

nas: {
  class: namespace
  label: TrueNAS Scale
  icon: assets/icons/hardware/truenas-scale.svg
  tooltip: Home Network Attached Storage (NAS)

  minio: {
    class: [application]
    label: MinIO
    icon: assets/icons/apps/minio.svg
    link: https://min.io/
    tooltip: MinIO is a high-performance, distributed object storage system.
  }
}

udm-pro: {
  class: hardware
  label: UDM-Pro
  icon: assets/icons/hardware/unifi.svg
  tooltip: UniFi Dream Machine Pro - Gateway & Network Controller
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                             amiya.akn Platform                             │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This namespace contains all the components of the amiya.akn platform,    │
# │   including applications, system components, security, storage, and        │
# │   infrastructure. Each component is categorized and described with its     │
# │   purpose, functionality, and interactions with other components.          │
# ╰────────────────────────────────────────────────────────────────────────────╯

amiya·akn: {
  infrastructure: {class: namespace}
  security: {class: namespace}
  storage: {class: namespace}
  system: {class: namespace}

  style.fill-pattern: none

  # ────────────────────────────────────────────────────────────────────────────
  # Infrastructure Components

  infrastructure.argocd: {
    class: [application]
    label: ArgoCD
    icon: assets/icons/apps/argo-cd.svg
    link: https://argoproj.github.io/cd/
    tooltip: ArgoCD is a declarative, GitOps continuous delivery tool for Kubernetes.
  }

  infrastructure.crossplane: {
    class: [application]
    label: Crossplane
    icon: assets/icons/system/crossplane.svg
    link: https://crossplane.io/
    tooltip: Crossplane is an open-source Kubernetes add-on that extends your cluster with managed resources from any cloud or on-prem environment.
  }

  infrastructure.talos-omni: {
    class: [application; undeployed]
    label: Talos Omni
    icon: assets/icons/hardware/talos.svg
    link: https://omni.siderolabs.com/
    tooltip: Talos Omni is a platform for managing Talos Linux clusters through a simplified interface.
  }

  # ────────────────────────────────────────────────────────────────────────────
  # Security Components
  
  security.authelia: {
    class: [application]
    label: Authelia
    icon: assets/icons/apps/authelia.svg
    link: https://www.authelia.com/
    tooltip: Authelia is an open-source authentication and authorization server.
  }

  security.openbao-stack: {
    class: [namespace]
    label: OpenBao Stack
    tooltip: OpenBao secret management stack with PostgreSQL backend

    openbao: {
      class: [application]
      label: OpenBao
      icon: assets/icons/apps/openbao.svg
      link: https://openbao.org/
      tooltip: OpenBao is an open-source, community-driven fork of Vault managed by the Linux Foundation. Uses multi-mount topology with dedicated project mounts and shared/ mount.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for OpenBao, managed by CloudNative-PG operator with automated backups to S3.
    }
  }

  security.pocket-id-stack: {
    class: [namespace]
    label: Pocket-ID Stack
    tooltip: Pocket-ID identity and access management stack with PostgreSQL backend

    pocket-id: {
      class: [application]
      label: Pocket-ID
      icon: assets/icons/apps/pocket-id.svg
      link: https://pocket-id.org/
      tooltip: Pocket-ID is an open-source identity and access management solution based only on passkeys.
    }

    postgresql: {
      class: [application-datastore]
      label: PostgreSQL
      icon: assets/icons/system/cloudnativepg.svg
      link: https://postgresql.org/
      tooltip: PostgreSQL database backend for Pocket-ID, managed by CloudNative-PG operator with automated backups to S3.
    }
  }

  security.yaldap: {
    class: [application]
    label: yaLDAP
    icon: assets/icons/apps/yaldap.png
    link: https://yaldap.com/
    tooltip: yaLDAP is a modern LDAP server.
  }

  # ────────────────────────────────────────────────────────────────────────────
  # Storage Components

  storage.minio: {
    class: [application; undeployed]
    label: MinIO
    icon: assets/icons/apps/minio.svg
    link: https://min.io/
    tooltip: MinIO is a high-performance, distributed object storage system.
  }

  storage.zot-registry: {
    class: [application; undeployed]
    label: zot registry
    icon: assets/icons/apps/zot-registry.svg
    link: https://zotregistry.dev/
    tooltip: Zot Registry is a self-hosted, privacy-focused, and easy-to-use image registry.
  }

  # ────────────────────────────────────────────────────────────────────────────
  # System Components

  system.cert-manager: {
    class: [application-system]
    label: Cert-Manager
    icon: assets/icons/system/cert-manager.svg
    link: https://cert-manager.io/
    tooltip: Cert-Manager is a Kubernetes controller that automates the management and issuance of TLS certificates.
  }

  system.cilium: {
    class: [application-system]
    label: Cilium
    icon: assets/icons/system/cilium.svg
    link: https://cilium.io/
    tooltip: Cilium is a networking, observability, and security solution with an eBPF-based dataplane.
  }

  system.envoy-gateway: {
    class: [application-system]
    label: Envoy Gateway
    icon: assets/icons/system/envoy-gateway.svg
    link: https://gateway.envoyproxy.io/
    tooltip: Envoy Gateway is a modern, open-source Kubernetes-native API gateway built on Envoy Proxy.
  }

  system.envoy-default-gateway: {
    class: [application-system]
    label: Envoy Default Gateway
    icon: assets/icons/system/envoy.svg
    link: https://gateway.envoyproxy.io/
    tooltip: Envoy to proxy all HTTP/HTTPS traffic in the cluster.
  }

  system.envoy-ldap-gateway: {
    class: [application-system]
    label: Envoy LDAP Gateway
    icon: assets/icons/system/envoy.svg
    link: https://gateway.envoyproxy.io/
    tooltip: Envoy to proxy all LDAP/LDAPS traffic in the cluster.
  }

  system.externaldns: {
    class: [application-system]
    label: ExternalDNS
    icon: assets/icons/system/external-dns.png
    link: https://github.com/kubernetes-sigs/external-dns
    tooltip: ExternalDNS is a Kubernetes controller that configures DNS resources.
  }

  system.external-secret: {
    class: [application-system]
    label: External-Secret
    icon: assets/icons/system/external-secret.svg
    link: https://external-secrets.io/
    tooltip: External-Secret is a Kubernetes controller that allows you to use external secret management systems.
  }

  system.longhorn: {
    class: [application-system]
    label: Longhorn
    icon: assets/icons/system/longhorn.svg
    link: https://longhorn.io/
    tooltip: Longhorn is a distributed block storage system for Kubernetes.
  }

  system.tailscale: {
    class: [application-system]
    label: Tailscale
    icon: assets/icons/system/tailscale.svg
    link: https://tailscale.com/
    tooltip: TailScale is a mesh VPN that makes it easy to connect your devices, wherever they are.
  }

  system.cloudnative-pg: {
    class: [application-system]
    label: CloudNative-PG
    icon: assets/icons/system/cloudnativepg.svg
    link: https://cloudnative-pg.io/
    tooltip: CloudNative-PG is a Kubernetes operator for PostgreSQL management with advanced features like automated backups and high availability.
  }

  # Other Components
  glance: {
    class: [application]
    label: Glance
    icon: assets/icons/apps/glance.png
    link: https://github.com/glanceapp/glance
    tooltip: A self-hosted dashboard that puts all your feeds in one place.
  }

  tailscale-connector: {
    label: Tailscale-Connector
    icon: assets/icons/system/tailscale.svg
    link: https://tailscale.com/kb/1441/kubernetes-operator-connector
    tooltip: Tailscale Connector for Kubernetes - Connects local network to tailnet
  }
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                                Connections                                 │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the various connections within the amiya.akn      │
# │   platform, including VPN, internal and external connections.              │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# VPN Connections

amiya·akn.system.tailscale <- tailnet: {class: [connect-from-vpn-backbone]}
amiya·akn.tailscale-connector -> localnet: {class: [connect-to-vpn-backbone]}
amiya·akn.tailscale-connector <- tailnet: {class: [connect-from-vpn-backbone]}

# ──────────────────────────────────────────────────────────────────────────────
# Internal Connections

amiya·akn.glance <- amiya·akn.system.envoy-default-gateway: { source-arrowhead: HTTP (8080) }

amiya·akn.infrastructure.argocd <- amiya·akn.system.envoy-default-gateway: { source-arrowhead: HTTP (8080) }
amiya·akn.infrastructure.argocd <- amiya·akn.system.tailscale: { class: [connect-from-vpn]; source-arrowhead: HTTP (8080) }

amiya·akn.infrastructure.talos-omni <- amiya·akn.system.envoy-default-gateway: { class: [undeployed]; source-arrowhead: HTTP (443) }

amiya·akn.security.openbao-stack.openbao -> amiya·akn.security.openbao-stack.postgresql: { source-arrowhead: PostgreSQL (5432) }
amiya·akn.security.openbao-stack.openbao <- amiya·akn.system.envoy-default-gateway: { source-arrowhead: HTTP (8200) }
amiya·akn.security.openbao-stack.openbao <- amiya·akn.system.tailscale: { class: [connect-from-vpn]; source-arrowhead: HTTP (8200) }
amiya·akn.security.openbao-stack.postgresql -> nas.minio: { source-arrowhead: HTTPS (9200) }

amiya·akn.security.pocket-id-stack.pocket-id -> amiya·akn.security.pocket-id-stack.postgresql: "psql (5432)" { }
amiya·akn.security.pocket-id-stack.pocket-id <- amiya·akn.system.envoy-default-gateway: "http (1411)" { }
amiya·akn.security.pocket-id-stack.postgresql -> nas.minio: "s3://s3.chezmoi.sh:9200" { }

amiya·akn.security.yaldap <- amiya·akn.security.authelia: { source-arrowhead: LDAP (8389) }
amiya·akn.security.yaldap <- amiya·akn.system.envoy-ldap-gateway: { source-arrowhead: LDAP (8389) }

amiya·akn.storage.minio <- amiya·akn.system.envoy-default-gateway: { class: [undeployed]; source-arrowhead: HTTP (9000) }

amiya·akn.storage.zot-registry -> amiya·akn.storage.minio: { class: [undeployed]; source-arrowhead: HTTP (5000) }
amiya·akn.storage.zot-registry <- amiya·akn.system.envoy-default-gateway: { class: [undeployed]; source-arrowhead: HTTP (5000) }

amiya·akn.system.cloudnative-pg -> amiya·akn.security.openbao-stack.postgresql: { class: [connect-management] }
amiya·akn.system.cloudnative-pg -> amiya·akn.security.pocket-id-stack.postgresql: { class: [connect-management] }

amiya·akn.system.envoy-gateway -> amiya·akn.system.envoy-default-gateway: { class: [connect-management] }
amiya·akn.system.envoy-gateway -> amiya·akn.system.envoy-ldap-gateway: { class: [connect-management] }

amiya·akn.system.envoy-default-gateway <- localnet: {
  source-arrowhead: |md
    HTTP (80)
    HTTPS (443)
  |
}
amiya·akn.system.envoy-ldap-gateway <- localnet: { source-arrowhead: LDAP (389) }

amiya·akn.system.external-secret -> amiya·akn.security.openbao-stack.openbao: { source-arrowhead: HTTP (8200) }

amiya·akn.system.longhorn <- amiya·akn.system.envoy-default-gateway: { source-arrowhead: HTTP (8000) }

# ──────────────────────────────────────────────────────────────────────────────
# External Connections

amiya·akn.glance -> internet: HTTPS (443) { class: [connect-to-internet] }

amiya·akn.infrastructure.argocd  -> internet: HTTPS (443) / SSH (22) { class: [connect-to-internet] }

amiya·akn.infrastructure.crossplane -> internet: HTTPS (443) {class: [connect-to-internet]}

amiya·akn.security.pocket-id-stack.pocket-id -> aws.ses: "smtps://email-smtp.us-east-1.amazonaws.com:465" { }
amiya·akn.security.pocket-id-stack.pocket-id -> pocket-id: "https://analytics.pocket-id.org:443" { }

amiya·akn.storage.zot-registry -> internet: HTTPS (443) { class: [connect-to-internet; undeployed] }

amiya·akn.system.cert-manager -> internet: HTTPS (443) {class: [connect-to-internet]}

amiya·akn.system.externaldns -> udm-pro: DNS updates
