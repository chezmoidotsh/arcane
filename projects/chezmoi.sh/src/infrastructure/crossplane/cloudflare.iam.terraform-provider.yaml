# Cloudflare API Token for Terraform provider
#
# Description:
#   This resource creates a Cloudflare API Token with specific permissions for the
#   Terraform provider to manage security configurations (WAF, rate limiting, zone settings).
#
# Permissions:
#   - Zone Read: Read zone information
#   - Zone WAF Edit: Manage WAF rules and configurations
#   - Zone Settings Edit: Manage zone settings (SSL/TLS, security headers, etc.)
#   - Account Rulesets Edit: Manage rulesets at account level
#
# Security:
#   The secret is synchronized to Vault (vault.chezmoi.sh) using PushSecret.
---
apiVersion: account.cloudflare.crossplane.io/v1alpha1
kind: APIToken
metadata:
  name: chezmoi-sh-terraform-provider
spec:
  forProvider:
    name: (chezmoi.sh) - terraform-provider
    policy:
      - effect: allow
        permissionGroups:
          - c8fed203ed3043cba015a93ad1616f1f # Zone Read (Zone)
          - 3030687196b94b638145a3953da2b699 # Zone Settings Edit (Zone)
          - c1fde68c7bcc44588cbb6ddbc16d6480 # Account Settings Read (Account)
          - 56907406c3d548ed902070ec4df0e328 # Account Rulesets Write (Account)
          - fb6778dc191143babbfaa57993f1d275 # Zone WAF Edit (Zone)
        resources:
          com.cloudflare.api.account.zone.2734d7b22cf00222046320ed3187cb94: "*"
          com.cloudflare.api.account.*: "*"
  writeConnectionSecretToRef:
    name: chezmoi.sh-cloudflare-token-terraform-provider
    namespace: crossplane-secrets
---
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: chezmoi.sh-cloudflare-token-terraform-provider
  namespace: crossplane-secrets
spec:
  refreshInterval: 1h
  secretStoreRefs:
    - kind: ClusterSecretStore
      name: vault.chezmoi.sh
  selector:
    secret:
      name: chezmoi.sh-cloudflare-token-terraform-provider
  template:
    metadata:
      annotations:
        description: Cloudflare API Token for Terraform provider
        origin: crossplane
        owner: chezmoi.sh
        renewal-process: |
          Remove the chezmoi-sh-terraform-provider APIToken then wait ArgoCD to create a new one.
  data:
    - conversionStrategy: None
      match:
        secretKey: attribute.value
        remoteRef:
          remoteKey: shared/data/third-parties/cloudflare/iam/chezmoi.sh/terraform-provider
          property: api_token
