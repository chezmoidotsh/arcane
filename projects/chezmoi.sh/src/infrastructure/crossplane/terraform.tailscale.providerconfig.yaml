---
apiVersion: cloudflare.crossplane.io/v1beta1
kind: ProviderConfig
metadata:
  name: tailscale
spec:
  configuration: |
    // Modules _must_ use remote state. The provider does not persist state.
    terraform {
      backend "kubernetes" {
        secret_suffix     = "providerconfig-tailscale"
        namespace         = "crossplane"
        in_cluster_config = true
      }
    }

    // Install Tailscale provider
    terraform {
      required_providers {
        tailscale = {
          source  = "tailscale/tailscale"
          version = "0.21.1"
        }
      }
    }
  credentials:
    - env: TAILSCALE_OAUTH_CLIENT_ID
      secretRef:
        name: tailscale-credentials
        key: oauth_client_id
    - env: TAILSCALE_OAUTH_CLIENT_SECRET
      secretRef:
        name: tailscale-credentials
        key: oauth_client_secret
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: tailscale-credentials
spec:
  refreshInterval: 720h # 30 days
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault.chezmoi.sh
  dataFrom:
    - extract:
        key: amiya.akn/crossplane/providers/tailscale
