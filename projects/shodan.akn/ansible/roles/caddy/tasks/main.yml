---
# =============================================================================
# Role: caddy â€” Reverse Proxy
# =============================================================================
# Installs Caddy via Homebrew, adds the requested DNS plugin,
# and configures a LaunchAgent to run it on boot.
# =============================================================================

- name: Install Caddy via Homebrew
  community.general.homebrew:
    name: caddy
    state: present
  register: _caddy_install
  notify: Restart Caddy

- name: Add Caddy DNS plugin
  ansible.builtin.command: "{{ caddy_bin_path }} add-package github.com/caddy-dns/{{ caddy_dns_plugin }}"
  register: _caddy_plugin
  changed_when: "'upgrade successful' in _caddy_plugin.stderr | lower or 'download successful' in _caddy_plugin.stderr | lower"
  notify: Restart Caddy

- name: Template Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_config_dir }}/Caddyfile"
    mode: "0644"
  notify: Reload Caddy

- name: Ensure User LaunchAgents directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/Library/LaunchAgents"
    state: directory
    mode: "0755"

- name: Template Caddy LaunchAgent
  ansible.builtin.template:
    src: caddy.plist.j2
    dest: "{{ lookup('env', 'HOME') }}/Library/LaunchAgents/sh.chezmoi.shodan.caddy.plist"
    mode: "0644"
  notify: Restart Caddy

- name: Ensure Caddy is loaded and started
  ansible.builtin.command: launchctl bootstrap gui/{{ lookup('pipe', 'id -u') }} "{{ lookup('env', 'HOME') }}/Library/LaunchAgents/sh.chezmoi.shodan.caddy.plist"
  register: _launchctl_load
  failed_when:
    - _launchctl_load.rc != 0
    - "'already bootstrapped' not in _launchctl_load.stderr"
  changed_when: false
