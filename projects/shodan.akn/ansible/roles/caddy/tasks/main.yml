---
# =============================================================================
# Role: caddy â€” Reverse Proxy
# =============================================================================
# Installs Caddy via Homebrew and manages its configuration.
# Uses the official Homebrew LaunchAgent.
# =============================================================================

- name: Install Caddy via Homebrew
  community.general.homebrew:
    name: caddy
    state: present
  register: _caddy_install
  notify: Restart Caddy

- name: Add Caddy DNS plugin
  ansible.builtin.command: "{{ caddy_bin_path }} add-package github.com/caddy-dns/{{ caddy_dns_plugin }}"
  register: _caddy_plugin
  failed_when: 
    - _caddy_plugin.rc != 0
    - "'package is already added' not in _caddy_plugin.stderr | lower"
  changed_when: "'upgrade successful' in _caddy_plugin.stderr | lower or 'download successful' in _caddy_plugin.stderr | lower"
  notify: Restart Caddy

- name: Ensure Homebrew etc directory exists
  ansible.builtin.file:
    path: "{{ caddy_config_dir }}"
    state: directory
    mode: "0755"

- name: Template Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_config_dir }}/Caddyfile"
    mode: "0644"
  notify: Reload Caddy

- name: Ensure Caddy is loaded and started
  community.general.launchd:
    name: homebrew.mxcl.caddy
    state: started
