---
# =============================================================================
# Role: common â€” Prerequisites
# =============================================================================
# Ensures:
#   - /Volumes/AI Storage is mounted
#   - Homebrew is installed
#   - UV and espeak-ng are available via Homebrew
#   - Service directories exist under {{ ai_storage_prefix }}/services/
# =============================================================================

- name: Assert AI Storage volume is mounted
  ansible.builtin.stat:
    path: "{{ ai_storage_prefix }}"
  register: _storage_stat

- name: Fail if AI Storage volume is not mounted
  ansible.builtin.fail:
    msg: >
      The volume '{{ ai_storage_prefix }}' is not mounted or does not exist.
      Please mount the volume before running this playbook.
  when: not _storage_stat.stat.exists or not _storage_stat.stat.isdir

# ---------------------------------------------------------------------------
# Homebrew
# ---------------------------------------------------------------------------
- name: Check if Homebrew is installed
  ansible.builtin.command: command -v brew
  register: _brew_check
  changed_when: false
  ignore_errors: true

- name: Fail if Homebrew is not installed
  ansible.builtin.fail:
    msg: "Homebrew is missing. Please install it first from https://brew.sh/"
  when: not _brew_stat.stat.exists

# ---------------------------------------------------------------------------
# System packages
# ---------------------------------------------------------------------------
- name: Install UV and espeak-ng via Homebrew
  community.general.homebrew:
    name:
      - uv
      - espeak-ng
    state: present
    update_homebrew: false

# ---------------------------------------------------------------------------
# Service directories
# ---------------------------------------------------------------------------
- name: Create service base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ ai_storage_prefix }}/services/litellm"
    - "{{ ai_storage_prefix }}/services/litellm/config"
    - "{{ ai_storage_prefix }}/services/litellm/logs"
    - "{{ ai_storage_prefix }}/services/kokoro"
    - "{{ ai_storage_prefix }}/services/kokoro/logs"
    - "{{ ai_storage_prefix }}/services/caddy"
    - "{{ ai_storage_prefix }}/services/caddy/config"
    - "{{ ai_storage_prefix }}/services/caddy/data"
    - "{{ ai_storage_prefix }}/services/caddy/logs"
