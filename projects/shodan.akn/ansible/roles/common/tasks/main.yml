---
# =============================================================================
# Role: common â€” Prerequisites
# =============================================================================
# Ensures:
#   - Homebrew is installed
#   - UV and espeak-ng are available via Homebrew
#   - Service directories exist under {{ ai_storage_prefix }}/services/
# =============================================================================

# ---------------------------------------------------------------------------
# Homebrew
# ---------------------------------------------------------------------------
- name: Check if Homebrew is installed
  ansible.builtin.command: command -v brew
  register: _brew_check
  changed_when: false
  ignore_errors: true

- name: Fail if Homebrew is not installed
  ansible.builtin.fail:
    msg: "Homebrew is missing. Please install it first from https://brew.sh/"
  when: _brew_check.rc != 0

- name: Get Homebrew prefix
  ansible.builtin.command: brew --prefix
  register: _brew_prefix_cmd
  changed_when: false

- name: Set brew_prefix fact
  ansible.builtin.set_fact:
    brew_prefix: "{{ _brew_prefix_cmd.stdout }}"

# ---------------------------------------------------------------------------
# System packages
# ---------------------------------------------------------------------------
- name: Install UV and espeak-ng via Homebrew
  community.general.homebrew:
    name:
      - uv
      - espeak-ng
    state: present
    update_homebrew: false

# ---------------------------------------------------------------------------
# Service directories
# ---------------------------------------------------------------------------
- name: Create service base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ ai_storage_prefix }}/services/litellm"
    - "{{ ai_storage_prefix }}/services/litellm/config"
    - "{{ ai_storage_prefix }}/services/litellm/logs"
    - "{{ ai_storage_prefix }}/services/kokoro"
    - "{{ ai_storage_prefix }}/services/kokoro/logs"
    - "{{ ai_storage_prefix }}/services/caddy"
    - "{{ ai_storage_prefix }}/services/caddy/config"
    - "{{ ai_storage_prefix }}/services/caddy/data"
    - "{{ ai_storage_prefix }}/services/caddy/logs"
