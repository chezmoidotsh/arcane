---
# CrowdSec AppSec Configuration - Disable Rule 930120 for Pangolin Hosts
# Managed by Ansible - DO NOT EDIT MANUALLY
#
# Purpose:
#   Disable CrowdSec OWASP CRS native rule 930120 specifically for requests
#   to Pangolin hosts on the site configuration endpoint.
#
# Rule 930120 Description:
#   Part of REQUEST-930-APPLICATION-ATTACK-LFI.conf from OWASP ModSecurity CRS
#   "OS File Access Attempt"
#
#   This rule detects attempts to access OS files (e.g. /etc/passwd, .htaccess, etc.)
#   by looking for common file names and paths in request arguments.
#
# Why Disable for Pangolin:
#   The rule is triggered when configuring the 'dockerSocketEnabled' field
#   on the endpoint /api/v1/site/1. This field name or value likely resembles
#   an OS file access pattern (e.g. docker.sock) which triggers the rule.
#
# Scope:
#   This rule is ONLY disabled for requests to the following Pangolin hosts
#   matching the specific URI /api/v1/site/1:
{% for domain in pangolin_domains %}
#     - https://{{ domain }}/api/v1/site/1
{% endfor %}
#   All other hosts and endpoints behind CrowdSec will continue to have this protection active.
#
# Security Consideration:
#   Disabling this rule for this specific endpoint reduces protection against
#   LFI attacks on that endpoint. Ensure that:
#   - Input validation is performed by the application
#   - Only trusted users can access this endpoint
#
# Implementation:
#   Uses the pre_eval hook with host and URI filters to selectively
#   disable the rule only for requests targeting the specific endpoint.
#
# References:
#   - OWASP CRS Rule 930120
#   - CrowdSec AppSec Hooks: https://docs.crowdsec.net/docs/appsec/hooks/
#   - RemoveInBandRuleByID: https://docs.crowdsec.net/docs/appsec/helpers/
#
name: custom/disable-rule-930120
default_remediation: ban
pre_eval:
  - filter: IsInBand == true && req.URI == "/api/v1/site/1" && ({% for domain in pangolin_domains %}req.Host == "{{ domain }}"{% if not loop.last %} || {% endif %}{% endfor %})
    apply:
      - RemoveInBandRuleByID(930120)
