---
# CrowdSec AppSec Configuration - Immich Application Profile
# Managed by Ansible - DO NOT EDIT MANUALLY
#
# Purpose:
#   Application-specific profile for Immich photo management platform to prevent
#   false positives from legitimate mobile/web client traffic while maintaining
#   security protections.
#
# Application: Immich
#   A self-hosted photo and video backup solution with mobile apps for iOS and Android.
#   Immich uses REST API patterns with authentication tokens and various HTTP methods
#   that may trigger WAF false positives under strict OWASP CRS rules.
#
# Scope:
#   Applied to requests matching:
{% for domain in crowdsec_appsec_domains.immich | default([]) %}
#     - Host: {{ domain }}
{% endfor %}
#
# Disabled Rules for Immich:
#   - 920180: POST without Content-Length or Transfer-Encoding headers
#             Reason: Immich /api/auth/validateToken endpoint sends POST with
#                     empty body during token validation, which is valid HTTP
#
#   - 920420: Request content type not allowed by policy
#             Reason: Immich authentication endpoints may not send Content-Type
#                     header for empty POST requests, which is valid for token
#                     validation operations
#
# Security Considerations:
#   - These rules are ONLY disabled for requests to Immich domains
#   - All other OWASP CRS protections remain active (SQL injection, XSS, etc.)
#   - Ensure Immich is kept up-to-date and properly authenticated
#   - Monitor CrowdSec alerts for unusual patterns on Immich endpoints
#
# Known Legitimate Patterns:
#   - User-Agent: "Immich_Android_*" (Immich Android app)
#   - User-Agent: "Immich_iOS_*" (Immich iOS app)
#   - Endpoints: /api/auth/validateToken, /api/auth/login, /api/asset/*
#   - Methods: GET, POST, PUT, DELETE (standard REST operations)
#
# References:
#   - Immich Documentation: https://immich.app/docs/
#   - Immich API: https://immich.app/docs/api/
#   - OWASP CRS Rules: 920180, 920420
#   - CrowdSec AppSec Hooks: https://docs.crowdsec.net/docs/appsec/hooks/
#
name: custom/allow-immich
default_remediation: ban

# Disable rules for Immich domains during in-band processing
pre_eval:
  - filter: |
      IsInBand == true && (
        {%- for domain in crowdsec_appsec_domains.immich | default([]) -%}
        req.Host == "{{ domain }}"
        {%- if not loop.last %} || {% endif -%}
        {%- endfor -%}
      )
    apply:
      # Allow POST without Content-Length for token validation
      - RemoveInBandRuleByID(920180)
      # Allow missing Content-Type for authentication endpoints
      - RemoveInBandRuleByID(920420)
