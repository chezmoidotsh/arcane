---
# ==============================================================================
# Site Playbook: Kazimierz.AKN VPS Infrastructure Orchestrator
# ==============================================================================
# Purpose:
#   Main orchestrator playbook for complete Kazimierz.AKN VPS infrastructure.
#   Configures proxy/firewall/WAF cluster with GitOps automation.
#
# Execution Order:
#   1. System Installation (system_setup role)
#      - Base system configuration
#      - Docker and Docker Compose v2
#      - Tailscale VPN with SSH
#      - UFW firewall
#      - Unattended security upgrades
#
#   2. GitOps Automation (gitops_automation role)
#      - Ansible from official PPA
#      - ansible-pull systemd service and timer
#      - Ansible Vault configuration
#      - Galaxy collections installation
#
#   3. ARA Records Ansible (ara_server role)
#      - ARA API server in Docker
#      - Ansible callback plugin
#      - Tailscale Serve HTTPS access
#
#   4. Pangolin Application Stack (pangolin role)
#      - Pangolin reverse proxy
#      - Gerbil WireGuard manager
#      - Traefik with Let's Encrypt
#
# Usage via ansible-pull (Manual):
#   export ANSIBLE_VAULT_PASSWORD="your-vault-password-here" # Set vault password checkov:skip=CKV_SECRET_6:Documentation example
#   ansible-pull \
#     --url https://github.com/chezmoidotsh/arcane \
#     --checkout main \
#     --directory /opt/chezmoidotsh/arcane \
#     --inventory projects/kazimierz.akn/src/infrastructure/ansible/inventory/local.yml \
#     --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD") \
#     --only-if-changed \
#     projects/kazimierz.akn/src/infrastructure/ansible/site.yml
#
# Automated Execution:
#   After initial setup, ansible-pull runs automatically every 15 minutes
#   via systemd timer configured in gitops_automation role.
#
# Monitoring:
#   systemctl status ansible-pull.timer
#   journalctl -u ansible-pull.service -f
# ==============================================================================

- name: Kazimierz.AKN VPS Infrastructure Deployment
  hosts: kazimierz
  gather_facts: true

  vars:
    # -------------------------------------------------------------------------
    # Slack Notification Configuration (ARNOS)
    # -------------------------------------------------------------------------
    arnos_slack_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33316231303561333631343930643665353039363765363564653039663762613831353562346538
      3565313238393232643937393030336630353136373432620a343531346561363164383032666162
      39336264663161636463306562653131313430363764336335313364313330336338323134333630
      3331656332613233640a373633623238633463356265316661346532373930353363626164623631
      37626662383136643832653835633739633830363066356135383566643033346535646232633337
      61333530346632613762623264366336636365323736313835653531633962346162386431356231
      306236623632646266396664656130643362

    arnos_slack_channel: "#notifications"
    arnos_slack_username: Ansible (kazimierz.akn)

    # -------------------------------------------------------------------------
    # ARA Records Ansible Configuration
    # -------------------------------------------------------------------------
    # API server URL (uses environment variable if set, otherwise public URL)
    arnos_ara_api_server: "{{ lookup('env', 'ARA_API_SERVER') | default(arnos_ara_public_url) }}"
    # Public URL accessible via Tailscale
    arnos_ara_public_url: https://kazimierz-akn.tail831c5d.ts.net

  pre_tasks:
    - name: "[Notification] Send Slack notification about playbook start"
      block:
        - name: Include notification role for start phase
          ansible.builtin.include_role:
            name: ../../../../../catalog/ansible/roles/ansible-run-notification-on-slack
          vars:
            notification_phase: start
      delegate_to: localhost
      run_once: true

    # Vault secret setup for gitops_automation role
    - name: "[Setup] Configure Ansible vault secret"
      ansible.builtin.include_role:
        name: gitops_automation
        tasks_from: vault_setup

  tasks:
    - block:
        - name: "[Step 1] Install and configure system components"
          ansible.builtin.include_role:
            name: system_setup
          tags: [system]

        - name: "[Step 2] Setup GitOps automation"
          ansible.builtin.include_role:
            name: gitops_automation
          tags: [gitops]

        - name: "[Step 3] Deploy and configure ARA Records Ansible"
          ansible.builtin.include_role:
            name: ara_server
          tags: [ara]

        - name: "[Step 4] Deploy Pangolin application stack"
          ansible.builtin.include_role:
            name: pangolin
          tags: [pangolin]

      rescue:
        - name: "[Notification] Send Slack notification about playbook failure"
          block:
            - name: Include notification role for rescue phase
              ansible.builtin.include_role:
                name: ../../../../../catalog/ansible/roles/ansible-run-notification-on-slack
              vars:
                notification_phase: rescue
          delegate_to: localhost
          run_once: true

      always:
        - name: "[Notification] Send Slack notification about playbook completion"
          block:
            - name: Include notification role for completion phase
              ansible.builtin.include_role:
                name: ../../../../../catalog/ansible/roles/ansible-run-notification-on-slack
              vars:
                notification_phase: completion
          delegate_to: localhost
          run_once: true
