---
# ==============================================================================
# Playbook: ARA Records Ansible Deployment
# ==============================================================================
# Purpose:
#   Deploy ARA (Ansible Run Analysis) for playbook execution tracking and
#   visualization, accessible via Tailscale Serve.
#
# Components Configured:
#   - ARA API Server running in Docker container (SQLite backend)
#   - ARA Ansible callback plugin for automatic run recording
#   - Tailscale Serve for secure HTTPS access to web interface
#   - Systemd service for ARA lifecycle management
#
# Access:
#   - ARA web interface: https://<tailscale-hostname>.ts.net
#   - API endpoint: http://127.0.0.1:8000
#
# Data Storage:
#   - SQLite database: Docker volume 'ara-data' at /opt/ara/ansible.sqlite
#   - Persistent across container restarts
#
# Security Considerations:
#   - ARA API exposed only to localhost (127.0.0.1:8000)
#   - Web interface accessible only via Tailscale network
#   - HTTPS automatically configured via Tailscale Serve
#   - Systemd service hardened with PrivateTmp and NoNewPrivileges
#
# Dependencies:
#   - Docker Engine and docker CLI
#   - Tailscale daemon (tailscaled.service)
#   - python3-ara package for callback plugin
#
# Tags:
#   - ara: All ARA-related tasks
#   - systemd: Systemd unit configuration
#   - ansible: Ansible callback configuration
# ==============================================================================

- name: Deploy ARA Records Ansible with Tailscale Serve
  hosts: kazimierz
  become: true

  vars:
    # -------------------------------------------------------------------------
    # ARA Docker Configuration
    # -------------------------------------------------------------------------
    ara_data_dir: /opt/ara
    ara_docker_image: docker.io/recordsansible/ara-api:latest@sha256:435dbcc0154b0494f245d79ec1c20af3b8f0d31bccf010522dc6125e08e7691d
    ara_port: 8000

    # -------------------------------------------------------------------------
    # Tailscale Serve Configuration
    # -------------------------------------------------------------------------
    ara_tailscale_serve_enabled: true

  handlers:
    - name: Reload systemd daemon configuration
      ansible.builtin.systemd:
        daemon_reload: true

  tasks:
    # ==========================================================================
    # ARA Systemd Service Configuration
    # ==========================================================================
    - name: Ensure ARA systemd service is configured with Docker and Tailscale Serve integration
      ansible.builtin.copy:
        dest: /etc/systemd/system/ara.service
        content: |
          [Unit]
          Description=ARA Records Ansible - API Server with Tailscale Serve
          Documentation=https://ara.recordsansible.org/
          Requires=docker.service tailscaled.service
          After=docker.service tailscaled.service network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          RemainAfterExit=yes

          # Pull latest ARA Docker image
          ExecStartPre=/usr/bin/docker pull {{ ara_docker_image }}

          # Start ARA API server container
          ExecStart=/usr/bin/docker run -d \
            --name ara-api \
            --restart unless-stopped \
            -p 127.0.0.1:{{ ara_port }}:8000 \
            -v ara-data:/opt/ara \
            -e ARA_ALLOWED_HOSTS="['*']" \
            -e ARA_CORS_ORIGIN_ALLOW_ALL=true \
            -e ARA_DATABASE_ENGINE=django.db.backends.sqlite3 \
            -e ARA_DATABASE_NAME=/opt/ara/ansible.sqlite \
            -e ARA_LOG_LEVEL=INFO \
            {{ ara_docker_image }}

          # Wait for ARA API to initialize
          ExecStartPost=/bin/sleep 5

          {% if ara_tailscale_serve_enabled %}
          # Configure Tailscale Serve to expose ARA web interface
          ExecStartPost=/usr/bin/tailscale serve --bg http://127.0.0.1:{{ ara_port }}
          {% endif %}

          # Graceful shutdown: stop and remove container
          ExecStop=/usr/bin/docker stop ara-api
          ExecStopPost=/usr/bin/docker rm -f ara-api
          {% if ara_tailscale_serve_enabled %}
          ExecStopPost=/usr/bin/tailscale serve reset
          {% endif %}

          # Restart policy configuration
          Restart=on-failure
          RestartSec=10s

          # Security hardening
          PrivateTmp=yes
          NoNewPrivileges=yes

          [Install]
          WantedBy=multi-user.target
        mode: "0644"
      notify:
        - Reload systemd daemon configuration
      tags:
        - ara
        - systemd

    - name: Flush handlers to reload systemd daemon
      ansible.builtin.meta: flush_handlers
      tags:
        - ara

    - name: Enable and start ARA systemd service
      ansible.builtin.systemd:
        name: ara
        enabled: true
        state: started
      tags:
        - ara

    - name: Wait for ARA API server to be ready and accepting connections
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ ara_port }}"
        timeout: 60
      tags:
        - ara

    # ==========================================================================
    # ARA Callback Plugin Installation
    # ==========================================================================
    - name: Ensure python3-ara package is installed for Ansible callback plugin
      ansible.builtin.apt:
        name:
          - python3-ara
        state: present
        update_cache: true
      tags:
        - ara
        - ansible

    - name: Ensure /etc/ansible directory exists for global Ansible configuration
      ansible.builtin.file:
        path: /etc/ansible
        state: directory
        mode: "0755"
      tags:
        - ara
        - ansible

    - name: Configure Ansible to use ARA callback plugin with HTTP API client
      ansible.builtin.blockinfile:
        path: /etc/ansible/ansible.cfg
        create: true
        mode: "0644"
        block: |
          [defaults]
          # ARA plugin paths (callback, action, lookup)
          callback_plugins=/usr/lib/python3/dist-packages/ara/plugins/callback
          action_plugins=/usr/lib/python3/dist-packages/ara/plugins/action
          lookup_plugins=/usr/lib/python3/dist-packages/ara/plugins/lookup

          [ara]
          # ARA API configuration
          api_client=http
          api_server=http://127.0.0.1:{{ ara_port }}
          localhost_as_hostname=true
          localhost_as_hostname_format=fqdn
      tags:
        - ara
        - ansible
