---
# ==============================================================================
# Playbook: System Installation and Configuration
# ==============================================================================
# Purpose:
#   Install and configure base system components for Kazimierz.AKN VPS.
#
# Components Configured:
#   - Docker Engine with Docker Compose v2 plugin
#   - Tailscale VPN mesh networking with SSH enabled
#   - UFW firewall with secure default-deny policy
#   - Unattended security upgrades with automatic reboot
#
# Security Considerations:
#   - SSH port 22 enabled initially (switch to Tailscale SSH after bootstrap)
#   - UFW default-deny incoming, allow outgoing
#   - Docker daemon logs limited to 3x10MB files
#   - Automatic security updates with 03:00 reboot window
#
# Dependencies:
#   - geerlingguy.docker role (v7.6.1+)
#   - artis3n.tailscale.machine role (v4.2.1+)
#   - community.general collection (v8.0.0+)
#
# Tags:
#   - system: All system configuration tasks
#   - docker: Docker installation and configuration
#   - tailscale: Tailscale VPN setup
#   - ufw: Firewall configuration
#   - security: Security-related tasks
# ==============================================================================

- name: Install and configure system components
  hosts: kazimierz
  become: true

  vars:
    # -------------------------------------------------------------------------
    # Tailscale Configuration
    # -------------------------------------------------------------------------
    tailscale_auth_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36366335616364373432646531633861613233366432313037666465376662363731373034336165
      3335303232393439393837343263383530383939313037320a393035333462383739633634633964
      32363731306233346431393434663333306664343234353836383533623636616366313438313739
      6363343666626161310a326439626332613663656238633034353164333461353230623133643835
      65336632313633336461393139656331656561616137393635383365316562626330316333376637
      63336438613761366563343235643833396534393466323137333536616438653134396162313830
      316461393563653164613139366539663334
    tailscale_hostname: kazimierz-akn
    # -------------------------------------------------------------------------
    # UFW Firewall Configuration
    # -------------------------------------------------------------------------
    # Note: SSH port 22 enabled for initial setup - Tailscale SSH recommended
    ufw_allowed_ports:
      - { port: 22, proto: tcp, comment: "SSH" }
      - { port: 80, proto: tcp, comment: "HTTP" }
      - { port: 443, proto: tcp, comment: "HTTPS" }
      - { port: 51820, proto: udp, comment: "Newt (Site Tunnels)" }
      - { port: 21820, proto: udp, comment: "Newt (Client Tunnels)" }

  handlers:
    - name: Enable and start UFW firewall
      community.general.ufw:
        state: enabled
        logging: "on"

  tasks:
    # ==========================================================================
    # Base System Configuration
    # ==========================================================================
    - name: Ensure system hostname is set to kazimierz.akn.chezmoi.sh
      ansible.builtin.hostname:
        name: kazimierz.akn.chezmoi.sh
      tags:
        - system
        - base

    - name: Ensure APT package cache is updated
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags:
        - system
        - base

    - name: Ensure base system packages are installed
      ansible.builtin.apt:
        name:
          - git
          - curl
          - gnupg
          - software-properties-common
        state: present
      tags:
        - system
        - base

    # ==========================================================================
    # Docker Installation
    # ==========================================================================
    - name: Ensure Docker and Compose plugin are installed and configured
      ansible.builtin.include_role:
        name: geerlingguy.docker
      vars:
        # Systemd service configuration
        docker_service_manage: true
        docker_service_state: started
        docker_service_enabled: true

        # Docker Compose plugin installation
        docker_install_compose_plugin: true
        docker_compose_package: docker-compose-plugin
        docker_compose_package_state: present
        # renovate: datasource=github-releases depName=docker/compose
        docker_compose_version: v2.32.1

        # Docker daemon configuration
        docker_users:
          - root
        docker_daemon_options:
          log-driver: json-file
          log-opts:
            max-size: 10m
            max-file: "3"
      tags:
        - system
        - docker

    # ==========================================================================
    # Tailscale VPN Installation
    # ==========================================================================
    - name: Ensure Tailscale VPN is installed and configured
      ansible.builtin.include_role:
        name: artis3n.tailscale.machine
      vars:
        tailscale_args: --ssh --hostname {{ tailscale_hostname }}
        tailscale_authkey: "{{ tailscale_auth_key }}"
        tailscale_oauth_ephemeral: true
        tailscale_oauth_preauthorized: true
        tailscale_tags:
          - svc-pangolin
      tags:
        - system
        - tailscale
        - networking

    # ==========================================================================
    # UFW Firewall Configuration
    # ==========================================================================
    - name: Ensure UFW firewall package is installed
      ansible.builtin.apt:
        name: ufw
        state: present
      tags:
        - system
        - ufw
        - networking
        - security

    - name: Configure UFW default policies (deny incoming, allow outgoing)
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }
      notify: Enable and start UFW firewall
      tags:
        - system
        - ufw
        - networking
        - security

    - name: Configure UFW allowed ports
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        comment: "{{ item.comment }}"
      loop: "{{ ufw_allowed_ports }}"
      notify: Enable and start UFW firewall
      tags:
        - system
        - ufw
        - networking
        - security

    # ==========================================================================
    # Unattended Upgrades Configuration
    # ==========================================================================
    - name: Ensure unattended-upgrades and apt-listchanges packages are installed
      ansible.builtin.apt:
        name:
          - unattended-upgrades
          - apt-listchanges
        state: present
      tags:
        - system
        - unattended-upgrades
        - security

    - name: Configure unattended-upgrades with security and auto-reboot settings
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          // Automatically upgrade packages from these origins
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
              "${distro_id}ESMApps:${distro_codename}-apps-security";
              "${distro_id}ESM:${distro_codename}-infra-security";
          };

          // Automatically reboot if required
          Unattended-Upgrade::Automatic-Reboot "true";
          Unattended-Upgrade::Automatic-Reboot-Time "03:00";

          // Send email notifications
          Unattended-Upgrade::Mail "root";
          Unattended-Upgrade::MailReport "on-change";

          // Remove unused dependencies
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
          Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";

          // System behavior
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::MinimalSteps "true";
          Unattended-Upgrade::InstallOnShutdown "false";

          // Logging
          Unattended-Upgrade::SyslogEnable "true";
          Unattended-Upgrade::SyslogFacility "daemon";
        mode: "0644"
      tags:
        - system
        - unattended-upgrades
        - security

    - name: Configure APT automatic update schedule (daily)
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::AutocleanInterval "7";
          APT::Periodic::Unattended-Upgrade "1";
        mode: "0644"
      tags:
        - system
        - unattended-upgrades
        - security

    - name: Ensure unattended-upgrades systemd service is enabled and started
      ansible.builtin.systemd:
        name: unattended-upgrades
        enabled: true
        state: started
      tags:
        - system
        - unattended-upgrades
        - security
