machine:
  # -- Node configuration
  type: controlplane
  network:
    hostname: kazimierz-akn-01
  certSANs:
    - kubernetes.kazimierz.akn.chezmoi.sh

  # -- Machine installation
  install:
    # enabled extensions:
    # - siderolabs/qemu-guest-agent
    image: factory.talos.dev/hcloud-installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515:v1.10.6
    wipe: true

  # -- Custom configuration (enable user namespaces)
  kubelet:
    extraArgs:
      rotate-server-certificates: true # NOTE: This is required for Metrics Server
    extraConfig:
      featureGates:
        UserNamespacesSupport: true
        UserNamespacesPodSecurityStandards: true
  sysctls:
    user.max_user_namespaces: "11255"

  # Features describe individual Talos features that can be switched on or off.
  features:
    # Configures host DNS caching resolver.
    hostDNS:
      enabled: true # Enable host DNS caching resolver.
      forwardKubeDNSToHost: true # Use the host DNS resolver as upstream for Kubernetes CoreDNS pods.
      resolveMemberNames: true # Enable DNS resolution of member names in Kubernetes.
    imageCache:
      localEnabled: false # Disable local image cache.

cluster:
  allowSchedulingOnControlPlanes: true

  # -- Network configuration (disable CNI to allow Cilium to work)
  network:
    cni:
      name: custom
      urls:
        - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/cilium/1.18.1.yaml
  proxy:
    disabled: true

  # -- Custom configuration (enable user namespaces)
  apiServer:
    extraArgs:
      feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true

  # -- Install extra components
  extraManifests:
    # -- Metrics Server
    - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/kubelet-serving-cert-approver/0.9.1.yaml
    - https://raw.githubusercontent.com/chezmoidotsh/arcane/refs/heads/main/catalog/talos/manifests/metric-server/0.7.2.yaml
