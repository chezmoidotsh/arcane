vars: {
  d2-config: {
    layout-engine: elk
    sketch: true
  }
}

...@../../docs/assets/d2/architecture-styles.d2

explanation: |md
  # kazimierz.akn Architecture

  This document describes the architecture \
  of the kazimierz.akn platform in a visual way \
  with all the components and how they \
  interact with each other.

  kazimierz.akn is a **VPS-based public access gateway** \
  powered by Pangolin that provides secure, easy-to-use \
  access to selected homelab services. It is designed as a \
  sacrificial edge layer that can be compromised without \
  impacting internal infrastructure.
| {
  near: top-left
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                              External Objects                              │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   These objects represent resources external to the kazimierz.akn VPS     │
# │   but which interact with or are used by it.                               │
# │   They include networks, backend clusters, and third-party services        │
# │   essential for the proper functioning, connectivity, security,            │
# │   or management of the gateway.                                            │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Networks

internet: {class: network}


# ──────────────────────────────────────────────────────────────────────────────
# External Services

pocket-id: {
  class: [application]
  label: Pocket-ID\n(auth.chezmoi.sh)
  icon: assets/icons/apps/pocket-id.svg
  link: https://pocket-id.org/
  tooltip: OIDC/OAuth2 SSO provider for authentication
}

mailjet: {
  class: [application]
  label: Mailjet
  icon: assets/icons/platform/mailjet.svg
  link: https://www.mailjet.com/
  tooltip: Transactional email service for notifications
}


# ──────────────────────────────────────────────────────────────────────────────
# Backend Clusters

lungmen·akn: {
  class: namespace
  label: lungmen·akn

  style.fill-pattern: none

  newt: {
    class: [application]
    label: Newt
    icon: assets/icons/system/pangolin.svg
    link: https://pangolin.net/
    tooltip: Pangolin service node providing secure tunnel to backend services
  }

  services: {
    class: [application]
    label: Backend Services\n(Jellyfin, Immich, etc.)
    icon: assets/icons/platform/kubernetes.svg
    tooltip: Home applications exposed through Newt
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                           kazimierz.akn VPS                                │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the VPS-based gateway running Pangolin,           │
# │   serving as a sacrificial edge layer for secure internet access to        │
# │   homelab services. The VPS is designed to be compromisable without        │
# │   affecting critical infrastructure.                                       │
# ╰────────────────────────────────────────────────────────────────────────────╯

vps: {
  label: kazimierz.akn
  class: namespace

  style.fill-pattern: none


  # ────────────────────────────────────────────────────────────────────────────
  # Proxy Stack Components

  proxy-stack: {
    label: Proxy Stack
    class: namespace
    style.fill-pattern: none

    pangolin: {
      class: [application]
      label: Pangolin
      icon: assets/icons/system/pangolin.svg
      link: https://pangolin.net/
      tooltip: Tunneled reverse proxy controller with web dashboard
    }

    gerbil: {
      class: [application]
      label: Gerbil
      icon: assets/icons/system/pangolin.svg
      link: https://pangolin.net/
      tooltip: WireGuard tunnel manager (site/client tunnels)
    }

    traefik: {
      class: [application]
      label: Traefik
      icon: assets/icons/system/traefik.svg
      link: https://traefik.io/
      tooltip: HTTP reverse proxy with automatic Let's Encrypt SSL
    }

    crowdsec: {
      class: [application]
      label: CrowdSec
      icon: assets/icons/apps/crowdsec.svg
      link: https://crowdsec.net/
      tooltip: Collaborative IPS/IDS with WAF and threat intelligence
    }
  }


  # ────────────────────────────────────────────────────────────────────────────
  # Infrastructure Components

  tailscale: {
    class: [application-system]
    label: Tailscale
    icon: assets/icons/platform/tailscale.svg
    link: https://tailscale.com/
    tooltip: Mesh VPN for secure SSH access and VPS administration
  }

  ansible: {
    class: [application-system]
    label: Ansible
    icon: assets/icons/apps/ansible.svg
    link: https://www.ansible.com/
    tooltip: GitOps automation via ansible-pull (15-minute sync)
  }

  ara: {
    class: [application-system]
    label: ARA
    icon: assets/icons/apps/ara-records-ansible.svg
    link: https://ara.recordsansible.org/
    tooltip: Playbook execution monitoring and auditing
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                                Connections                                 │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the various connections between the VPS           │
# │   and external systems (internet, backend cluster, external services).     │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Internet to VPS Flow

internet -> vps.proxy-stack.traefik: |md
    HTTP (80)
    HTTPS (443)
  | { class: [connect-from-internet] }


# ──────────────────────────────────────────────────────────────────────────────
# VPS to External Services

vps.proxy-stack.pangolin -> pocket-id: "OIDC Authentication\n(auth.chezmoi.sh:443)" {class: [connect-to-internet]}

vps.proxy-stack.pangolin -> mailjet: "SMTP\n(in-v3.mailjet.com:587)" {class: [connect-to-internet]}

vps.proxy-stack.traefik -> internet: |md
    Let's Encrypt
    (acme-v02.api.letsencrypt.org:443)
  | {class: [connect-to-internet]}

vps.tailscale -> internet: "Tailscale API\n(api.tailscale.com:443)" {class: [connect-to-internet]}

vps.ansible -> internet: "Git Pull\n(github.com:443)" {class: [connect-to-internet]}


# ──────────────────────────────────────────────────────────────────────────────
# Proxy Stack Internal Connections

vps.proxy-stack.traefik -> vps.proxy-stack.crowdsec: "Bouncer API\nIP Blocklist"

vps.proxy-stack.traefik -> vps.proxy-stack.gerbil: "Proxied Traffic"

vps.proxy-stack.crowdsec -> vps.proxy-stack.traefik: "Log Analysis"

vps.proxy-stack.gerbil -> vps.proxy-stack.pangolin: "Configuration Sync\n(API)"

vps.proxy-stack.crowdsec -> internet: "CrowdSec API\n(api.crowdsec.net:443)" { class: [connect-to-internet] }


# ──────────────────────────────────────────────────────────────────────────────
# Infrastructure Connections

vps.ansible -> vps.ara: "Callback Plugin\nPlaybook Recording"

vps.tailscale -> vps.ara: "Tailscale Serve\n(HTTPS Access)"


# ──────────────────────────────────────────────────────────────────────────────
# Pangolin to Backend Cluster (WireGuard Tunnel)

vps.proxy-stack.gerbil -> lungmen·akn.newt: |md
    WireGuard Site Tunnel
    (UDP 51820)
  | { class: [connect-from-vpn-backbone] }

lungmen·akn.newt -> lungmen·akn.services: "Proxied Requests"
