vars: {
  d2-config: {
    layout-engine: elk
    sketch: true
  }
}

...@../../docs/assets/d2/architecture-styles.d2

explanation: |md
  # kazimierz.akn Architecture

  This document describes the architecture \
  of the kazimierz.akn platform in a visual way \
  with all the components and how they \
  interact with each other.

  kazimierz.akn is a **VPS-based public access gateway** \
  powered by Pangolin that provides secure, easy-to-use \
  access to selected homelab services. It is designed as a \
  sacrificial edge layer that can be compromised without \
  impacting internal infrastructure.
| {
  near: top-left
}

# ╭────────────────────────────────────────────────────────────────────────────╮
# │                              External Objects                              │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   These objects represent resources external to the kazimierz.akn VPS     │
# │   but which interact with or are used by it.                               │
# │   They include networks, backend clusters, and third-party services        │
# │   essential for the proper functioning, connectivity, security,            │
# │   or management of the gateway.                                            │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Networks

internet: {class: network}


# ──────────────────────────────────────────────────────────────────────────────
# External Services

pocket-id: {
  class: [application]
  label: Pocket-ID\n(auth.chezmoi.sh)
  icon: assets/icons/apps/pocket-id.svg
  link: https://pocket-id.org/
  tooltip: OIDC/OAuth2 SSO provider for authentication
}

mailjet: {
  class: [application]
  label: Mailjet
  icon: assets/icons/platform/mailjet.svg
  link: https://www.mailjet.com/
  tooltip: Transactional email service for notifications
}


# ──────────────────────────────────────────────────────────────────────────────
# Backend Clusters

lungmen·akn: {
  class: namespace
  label: lungmen·akn

  style.fill-pattern: none

  newt: {
    class: [application]
    label: Newt
    icon: assets/icons/system/pangolin.svg
    link: https://pangolin.net/
    tooltip: Pangolin service node providing secure tunnel to backend services
  }

  services: {
    class: [application]
    label: Backend Services\n(Jellyfin, Immich, etc.)
    icon: assets/icons/platform/kubernetes.svg
    tooltip: Home applications exposed through Newt
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                           kazimierz.akn VPS                                │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the VPS-based gateway running Pangolin,           │
# │   serving as a sacrificial edge layer for secure internet access to        │
# │   homelab services. The VPS is designed to be compromisable without        │
# │   affecting critical infrastructure.                                       │
# ╰────────────────────────────────────────────────────────────────────────────╯

vps: {
  label: kazimierz.akn
  class: namespace

  style.fill-pattern: none


  # ────────────────────────────────────────────────────────────────────────────
  # VPS Components

  pangolin: {
    class: [application]
    label: Pangolin
    icon: assets/icons/system/pangolin.svg
    link: https://pangolin.net/
    tooltip: Edge node - Identity-aware reverse proxy with WAF and access control
  }

  crowdsec: {
    class: [application]
    label: CrowdSec
    icon: assets/icons/apps/crowdsec.svg
    link: https://crowdsec.net/
    tooltip: Collaborative IPS/IDS with behavioral detection and community threat intelligence
  }

  tailscale: {
    class: [application-system]
    label: Tailscale
    icon: assets/icons/platform/tailscale.svg
    link: https://tailscale.com/
    tooltip: Mesh VPN for secure SSH access and VPS administration
  }
}



# ╭────────────────────────────────────────────────────────────────────────────╮
# │                                Connections                                 │
# ├────────────────────────────────────────────────────────────────────────────┤
# │ Desc:                                                                      │
# │   This section describes the various connections between the VPS           │
# │   and external systems (internet, backend cluster, external services).     │
# ╰────────────────────────────────────────────────────────────────────────────╯

# ──────────────────────────────────────────────────────────────────────────────
# Internet to VPS Flow

internet -> vps.pangolin: |md
    HTTP (80)
    HTTPS (443)
  | { class: [connect-from-internet] }


# ──────────────────────────────────────────────────────────────────────────────
# VPS to External Services

vps.pangolin -> pocket-id: "OIDC Authentication\n(auth.chezmoi.sh:443)" {class: [connect-to-internet]}

vps.pangolin -> mailjet: "SMTP\n(in-v3.mailjet.com:587)" {class: [connect-to-internet]}

vps.pangolin -> internet: |md
    Let's Encrypt
    (acme-v02.api.letsencrypt.org:443)
  | {class: [connect-to-internet]}

vps.tailscale -> internet: "Tailscale API\n(api.tailscale.com:443)" {class: [connect-to-internet]}


# ──────────────────────────────────────────────────────────────────────────────
# Security Flow

vps.pangolin -> vps.crowdsec: "IP Blocklist\nThreat Intelligence"

vps.crowdsec -> internet: "CrowdSec API\n(api.crowdsec.net:443)" { class: [connect-to-internet] }


# ──────────────────────────────────────────────────────────────────────────────
# Pangolin to Backend Cluster (WireGuard Tunnel)

vps.pangolin -> lungmen·akn.newt: { class: [connect-from-vpn-backbone] }

lungmen·akn.newt -> lungmen·akn.services: "Proxied Requests"
