# =============================================================================
# Arcane Infrastructure Development Environment Configuration
# =============================================================================
# This mise configuration provides a complete development environment for
# managing the Arcane homelab infrastructure. It installs all necessary tools
# and configures environment variables for GitOps operations across multiple
# Kubernetes clusters.
#
# Usage:
#   mise install    # Install all tools and apply environment
#   mise trust      # Trust this configuration (if prompted)
#
# For project-specific configurations, see:
#   projects/{cluster}/.mise.toml         # Cluster-specific tasks
# =============================================================================

[env]
# -----------------------------------------------------------------------------
# Kubernetes Configuration
# -----------------------------------------------------------------------------
# Kubernetes client configuration file containing cluster access credentials
# Supports multiple cluster contexts for the Arcane infrastructure
KUBECONFIG = "{{ config_root }}/.mise/kubeconfig"

# Krew plugin manager root directory for kubectl plugins
# Extends kubectl functionality with community and vendor plugins
KREW_ROOT = "{{ config_root }}/.mise/krew"

# -----------------------------------------------------------------------------
# Helm Package Manager Configuration  
# -----------------------------------------------------------------------------
# Helm is used for deploying and managing Kubernetes applications via charts
# These paths isolate Helm data from system-wide installations

HELM_CACHE_HOME = "{{ config_root }}/.mise/helm/cache"
HELM_CONFIG_HOME = "{{ config_root }}/.mise/helm/config"
HELM_DATA_HOME = "{{ config_root }}/.mise/helm/data"

# -----------------------------------------------------------------------------
# Security and Secret Management
# -----------------------------------------------------------------------------
# SOPS (Secrets OPerationS) Age encryption key file
# Used for encrypting sensitive data in Git repositories
SOPS_AGE_KEY_FILE = "{{ config_root }}/.mise/age/key.txt"

# OpenBao (Vault fork) server address for secret management
# Centralized secret storage for the Arcane infrastructure
VAULT_ADDR = "https://vault.chezmoi.sh"

# -----------------------------------------------------------------------------
# Talos Configuration
# -----------------------------------------------------------------------------
# Talos configuration file managed by the talos:ctx script
# Points to the shared configuration file used by all Talos operations
TALOS_CONFIG_DIR = "{{ config_root }}/.mise/talos"
TALOSCONFIG = "{{ env.TALOS_CONFIG_DIR }}/config"

# -----------------------------------------------------------------------------
# Path Extensions
# -----------------------------------------------------------------------------
# Additional directories added to PATH for tool accessibility
_.path = [
  "{{ config_root }}/scripts",        # Arcane operational scripts
  "{{ config_root }}/.mise/krew/bin", # Kubectl plugins installed via Krew
]

# -----------------------------------------------------------------------------
# Python Virtual Environment
# -----------------------------------------------------------------------------
# Isolated Python environment for any Python-based tools or scripts
_.python.venv = { path = ".mise/python", create = true, uv_create_args = [
  '--seed',
] }

# =============================================================================
# Tool Installation Matrix
# =============================================================================
# Tools are organized by functional category for infrastructure management
# All tools default to "latest" version unless stability requires pinning

[tools]
# -----------------------------------------------------------------------------
# Kubernetes Core Tools
# -----------------------------------------------------------------------------
# Essential tools for Kubernetes cluster management and operations

helm = "latest"    # Kubernetes package manager for deploying applications via charts
krew = "latest"    # Kubectl plugin manager for extending functionality
ksops = "latest"   # KSOPS plugin for Kustomize to handle SOPS-encrypted secrets
kubectl = "latest" # Kubernetes CLI for managing clusters and resources

# -----------------------------------------------------------------------------
# Infrastructure Management Tools
# -----------------------------------------------------------------------------
# Platform-specific tools for managing infrastructure components

"pipx:ansible-core" = { version = "latest", uvx_args = "--with ansible" } # Core Ansible package required by ansible

argocd = "latest"   # ArgoCD CLI for GitOps application deployment and management
hcloud = "latest"   # Hetzner Cloud CLI for managing cloud resources
openbao = "latest"  # OpenBao CLI for secret management (HashiCorp Vault fork)
talosctl = "latest" # Talos Linux cluster management tool for bare-metal Kubernetes

# -----------------------------------------------------------------------------
# Security and Data Tools
# -----------------------------------------------------------------------------
# Tools for handling secrets, data processing, and security operations

dive = "latest" # Container image analysis tool for security scanning
yq = "latest"   # YAML/JSON processor for configuration file manipulation

# -----------------------------------------------------------------------------
# Development and Documentation Tools
# -----------------------------------------------------------------------------
# Tools supporting development workflows and documentation generation

"aqua:terrastruct/d2" = "latest" # Diagram-as-code tool for generating architecture visualizations
"npm:ulid-cli" = "latest"        # ULID generator for unique identifiers in distributed systems
"ubi:runmedev/runme" = "latest"  # Interactive markdown execution tool for runbooks and documentation
gum = "latest"                   # Terminal UI framework for interactive scripts and prompts
uv = "latest"                    # Extremely fast Python package and project manager

# -----------------------------------------------------------------------------
# Vault (OpenBao) Authentication Tasks
# -----------------------------------------------------------------------------
# Tasks for logging into the OpenBao (Vault) secrets manager using OIDC authentication.
# The 'bao:login' task performs a standard user login, while 'bao:login:admin' uses the admin role.

[tasks."bao:login"]
description = "Log in to Vault with the CLI"
run = "bao login -method=oidc -path=pocket-id"

[tasks."bao:login:admin"]
description = "Log in to Vault with the CLI using administrative privileges"
run = "bao login -method=oidc -path=pocket-id role=admin"

# -----------------------------------------------------------------------------
# Talos Context Management Tasks
# -----------------------------------------------------------------------------
# Tasks for managing Talos cluster contexts using OpenBao secure storage.
# Contexts are stored in personal namespace with proper isolation and metadata.

[tasks."talos:list"]
description = "List available Talos contexts from OpenBao"
run = "scripts/talos:ctx list"

[tasks."talos:use"]
description = "Switch to Talos context: mise run talos:use -- <cluster>"
run = "scripts/talos:ctx get $@"

[tasks."talos:store"]
description = "Store current Talos context in OpenBao: mise run talos:store -- <cluster>"
run = "scripts/talos:ctx store $@"

[tasks."talos:select"]
description = "Interactive Talos context selection"
run = "scripts/talos:ctx select"

[tasks."talos:dashboard"]
description = "Launch dashboard for context: mise run talos:dashboard -- <cluster>"
run = "scripts/talos:ctx dashboard $@"

[tasks."talos:nodes"]
description = "List cluster nodes: mise run talos:nodes -- [cluster]"
run = "scripts/talos:ctx nodes $@"
