---
apiVersion: policies.kyverno.io/v1alpha1
kind: MutatingPolicy
metadata:
  name: enforce-local-registry
  annotations:
    policies.kyverno.io/title: Enforce local OCI mirror and pull policy
    policies.kyverno.io/category: Supply Chain
    policies.kyverno.io/subject: Pods
    policies.kyverno.io/description: |
      Prefix every workload image with the local registry mirror oci.chezmoi.sh and
      force imagePullPolicy to Always so nodes never trust cached layers. ZOT images
      are excluded to keep them sourced from the upstream registry.
      System-critical pods (marked via priorityClassName or annotation) are also
      excluded to ensure cluster stability.
      WARNING: This policy may interfere with pod managed by operators or controllers
      that expect specific image names, like Cloud Native Postgres operator.
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values: [kyverno-system, kube-system, kube-public, kube-node-lease]

  matchConditions:
    - name: exclude-critical-pods
      expression: |
        !(has(object.metadata.annotations) && 'scheduler.alpha.kubernetes.io/critical-pod' in object.metadata.annotations) &&
        !(has(object.spec.priorityClassName) && (object.spec.priorityClassName == 'system-cluster-critical' || object.spec.priorityClassName == 'system-node-critical'))

  mutations:
    - patchType: ApplyConfiguration
      applyConfiguration:
        expression: |
          Object{
            spec: Object.spec{
              containers: object.spec.containers.map(c,
                Object.spec.containers{
                  name: c.name,
                  image: c.image.startsWith('oci.chezmoi.sh/') || c.image.startsWith('ghcr.io/project-zot/') ?
                    c.image :
                    c.image.split('/').size() == 1 ?
                      'oci.chezmoi.sh/docker.io/library/' + c.image :
                      c.image.split('/').size() == 2 ?
                        'oci.chezmoi.sh/docker.io/' + c.image :
                        'oci.chezmoi.sh/' + c.image,
                  imagePullPolicy: 'Always'
                }
              ),
              initContainers: has(object.spec.initContainers) ?
                object.spec.initContainers.map(c,
                  Object.spec.initContainers{
                    name: c.name,
                    image: c.image.startsWith('oci.chezmoi.sh/') || c.image.startsWith('ghcr.io/project-zot/') ?
                      c.image :
                      c.image.split('/').size() == 1 ?
                        'oci.chezmoi.sh/docker.io/library/' + c.image :
                        c.image.split('/').size() == 2 ?
                          'oci.chezmoi.sh/docker.io/' + c.image :
                          'oci.chezmoi.sh/' + c.image,
                    imagePullPolicy: 'Always'
                  }
                ) : []
            }
          }

  evaluation:
    admission:
      enabled: true
    mutateExisting:
      enabled: true

  webhookConfiguration:
    timeoutSeconds: 10
