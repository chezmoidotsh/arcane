---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: openbao.xremoteclustervaults.vault.chezmoi.sh
spec:
  compositeTypeRef:
    apiVersion: vault.chezmoi.sh/v1alpha1
    kind: XRemoteClusterVault
  mode: Pipeline
  pipeline:
    # Fetch CA certificate and token reviewer JWT from secret if specified
    - step: fetch-ca-cert-secret
      functionRef:
        name: function-extra-resources
      input:
        apiVersion: extra-resources.fn.crossplane.io/v1beta1
        kind: Input
        spec:
          extraResources:
            - kind: Secret
              apiVersion: v1
              into: kubernetes-reviewer-secrets
              type: Selector
              selector:
                maxMatch: 1
                matchLabels:
                  - key: vault.crossplane.chezmoi.sh/cluster-name
                    type: FromCompositeFieldPath
                    valueFromFieldPath: spec.name
                minMatch: 1

    # Create KV v2 mount for the remote cluster
    - step: create-vault-mount
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ $xr := getCompositeResource . }}
            ---
            apiVersion: vault.vault.upbound.io/v1alpha1
            kind: Mount
            metadata:
              annotations:
                crossplane.io/external-name: {{ $xr.spec.name }}
                gotemplating.fn.crossplane.io/composition-resource-name: VaultMount
              name: {{ $xr.spec.name }}
            spec:
              deletionPolicy: Orphan
              forProvider:
                description: kv v2 mount for remote cluster {{ $xr.spec.name }}
                options:
                  version: "2"
                path: {{ $xr.spec.name }}
                type: kv
              providerConfigRef:
                name: {{ $xr.spec.providerConfigRef.name | default "default" }}

    # Create Kubernetes auth backend for remote cluster
    - step: create-auth-backend
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ $xr := getCompositeResource . }}
            ---
            apiVersion: auth.vault.upbound.io/v1alpha1
            kind: Backend
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: AuthBackend
              name: {{ $xr.spec.name }}
            spec:
              deletionPolicy: Delete
              forProvider:
                path: {{ $xr.spec.name }}
                type: kubernetes
                description: kubernetes auth backend for cluster {{ $xr.spec.name }}
              providerConfigRef:
                name: {{ $xr.spec.providerConfigRef.name | default "default" }}

    # Wait for backend to be ready
    - step: wait-for-backend
      functionRef:
        name: function-auto-ready

    # Configure auth backend for remote cluster
    - step: configure-auth-backend
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ $xr := getCompositeResource . }}
            ---
            apiVersion: kubernetes.vault.upbound.io/v1alpha1
            kind: AuthBackendConfig
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: AuthBackendConfig

              name: {{ $xr.spec.name }}-config
            spec:
              deletionPolicy: Delete
              forProvider:
                backendRef:
                  name: {{ $xr.spec.name }}
                kubernetesHost: {{ $xr.spec.host }}
                disableLocalCaJwt: true
                {{- $kubernetesReviewerSecrets := index (index .context "apiextensions.crossplane.io/extra-resources") "kubernetes-reviewer-secrets" }}
                {{- $secret := index $kubernetesReviewerSecrets 0 }}
                kubernetesCaCert: |- {{ index $secret.data "ca.crt" | b64dec | nindent 6 }}
                tokenReviewerJwtSecretRef:
                  key: token
                  name: {{ $secret.metadata.name }}
                  namespace: {{ $secret.metadata.namespace }}
              providerConfigRef:
                name: {{ $xr.spec.providerConfigRef.name | default "default" }}

    # Create ESO policy for remote cluster
    - step: create-eso-policy
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ $xr := getCompositeResource . }}
            {{ $clusterName := $xr.spec.name }}
            {{ $enableSharedAccess := $xr.spec.enableSharedAccess | default true }}
            ---
            apiVersion: vault.vault.upbound.io/v1alpha1
            kind: Policy
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: ESOPolicy
              name: {{ $clusterName }}-eso-policy
            spec:
              deletionPolicy: Delete
              forProvider:
                name: {{ $clusterName }}-eso-policy
                policy: |
                  # Allow ESO to read all secrets in the project path
                  path "{{ $clusterName }}/*" { capabilities = ["read"] }
                  {{- if $enableSharedAccess }}

                  # Allow ESO to read all secrets in the shared/third-parties path scoped to this cluster
                  path "shared/+/third-parties/+/+/{{ $clusterName }}/*" { capabilities = ["read"] }

                  # Allow ESO to read all secrets in the shared/certificates path
                  path "shared/+/certificates/*" { capabilities = ["read"] }
                  {{- end }}
              providerConfigRef:
                name: {{ $xr.spec.providerConfigRef.name | default "default" }}

    # Create ESO role for remote cluster
    - step: create-eso-role
      functionRef:
        name: function-go-templating
      input:
        apiVersion: gotemplating.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            {{ $xr := getCompositeResource . }}
            {{ $clusterName := $xr.spec.name }}
            {{ $additionalPolicies := $xr.spec.additionalPolicies | default (list) }}
            ---
            apiVersion: kubernetes.vault.upbound.io/v1alpha1
            kind: AuthBackendRole
            metadata:
              annotations:
                gotemplating.fn.crossplane.io/composition-resource-name: ESORole
              name: {{ $clusterName }}-eso-role
            spec:
              deletionPolicy: Delete
              forProvider:
                backend: {{ $clusterName }}
                roleName: {{ $clusterName }}-eso-role
                boundServiceAccountNames:
                  - external-secrets
                boundServiceAccountNamespaces:
                  - external-secrets-system
                tokenPolicies:
                  - {{ $clusterName }}-eso-policy
                {{- range $policy := $additionalPolicies }}
                  - {{ $policy }}
                {{- end }}
                tokenTtl: 900
                tokenMaxTtl: 1800
              providerConfigRef:
                name: {{ $xr.spec.providerConfigRef.name | default "default" }}

    # Wait for all resources to be ready
    - step: wait-for-resources
      functionRef:
        name: function-auto-ready
