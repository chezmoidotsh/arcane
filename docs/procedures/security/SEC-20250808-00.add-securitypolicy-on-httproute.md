## Procedure SEC-20250808-00: Adding an OIDC SecurityPolicy to an HTTPRoute

This procedure details how to secure an application exposed via an `HTTPRoute` with OIDC authentication. It relies on a technology stack composed of Envoy Gateway, Authelia as an identity provider (IdP), and OpenBao/Vault for secret management.

This procedure provides the necessary steps to add OIDC authentication to an application via a SecurityPolicy, in a simple and reproducible manner.

### Technical framework and conventions

The procedure applies to a specific project tree structure (`projects/<cluster>/src/...`), where each application has its own directory.

To ensure consistency and maintainability, the following conventions are applied:

* **Vault Path**: OIDC client secrets are stored in Vault under the structured path `<cluster>/<app>/auth/oidc-client`.
* **SecurityPolicy Naming**: The file must be placed in a `security/` subfolder within the application directory and strictly named: `<httproute>.securitypolicy.yaml`.
* **Authelia Configuration**: Secret and client declarations must be added following alphabetical order in Authelia's central files to facilitate reviews and avoid conflicts.

### Prerequisites

Before starting, ensure that the environment is functional and that the following tools are installed and configured: `bao`, `jq`, `yq` (v4+), `docker` (or an equivalent like `podman`), and `kubectl`.

You must also have:

* Access to `kubectl` with necessary permissions to manage resources in the application namespace.
* Access to `bao` with write permissions on the relevant Vault path.
* An existing `HTTPRoute` file for the application you want to protect.

### Required inputs

To execute the generation script, you will need to define two variables:

* `APP_DIR`: The path to the application directory (e.g., `projects/<cluster>/src/apps/<app>`)
* `HTTPROUTE_FILE`: The full path to the application's `HTTPRoute` file.

***

## Step 1 — Generate the OIDC client JSON

This step uses a *one-shot* script to generate a secure and modern OIDC client configuration. It includes **PKCE (Proof Key for Code Exchange)** by default, an essential security measure that protects against authorization code interception attacks.

> \[!IMPORTANT]
> **Note on OIDC `scopes` selection**
>
> By default, the procedure only uses the `openid` scope. This is a deliberate security choice aimed at applying the principle of least privilege: providing only authentication (AuthN) and not leaking any user information.
>
> If your application needs additional information, you can add other scopes:
>
> * `profile`: Provides basic profile information (first name, last name, etc.).
> * `email`: Provides the user's email address.
> * `groups`: Crucial for role-based access control (RBAC). It transmits the user's group memberships.
>
> To add them, modify the `scopes` line in the `jq` command below. For example:
> `"scopes": ["openid", "profile", "email", "groups"]`

The script automatically derives the cluster name, application name, and `redirect_uri` from the input variables.

> \[!NOTE]
> As an agent, it's not necessary to run the script to generate the OIDC client JSON; it can also be generated logically by modifying the values directly in the JSON.

```bash
# Inputs
APP_DIR="projects/<cluster>/src/apps/<apps>"                # To adapt
HTTPROUTE_FILE="projects/<cluster>/src/apps/<apps>/<httproute_file>.yaml"  # To adapt

# Basic derivations
CLUSTER="$(echo "$APP_DIR" | awk -F/ '{print $2}')"
APP="$(basename "$APP_DIR")"
HOSTNAME="$(yq -r '.spec.hostnames[0]' "$HTTPROUTE_FILE")"
REDIRECT_URI="https://${HOSTNAME}/oauth2/callback"

# Client identity
CLIENT_ID="$(docker run --rm authelia/authelia:latest authelia crypto rand --length 25 --charset rfc3986 | awk -F': ' '{print $2}')"
CLIENT_NAME="$APP"

# Secret generation via a pinned version of Authelia to ensure reproducibility
AUTHELIA_IMAGE="authelia/authelia:latest"
HASH_OUT="$(docker run --rm "$AUTHELIA_IMAGE" authelia crypto hash generate pbkdf2 --variant sha512 --random --random.length 72 --random.charset rfc3986)"
CLIENT_PASSWORD="$(printf '%s\n' "$HASH_OUT" | awk -F': ' '/Random Password:/ {print $2}')"
CLIENT_SECRET="$(printf '%s\n' "$HASH_OUT" | awk -F': ' '/Digest:/ {print $2}')"

# OIDC client JSON (with PKCE enabled by default)
jq -n --arg id "$CLIENT_ID" \
      --arg name "$CLIENT_NAME" \
      --arg password "$CLIENT_PASSWORD" \
      --arg secret "$CLIENT_SECRET" \
      --arg redirect "$REDIRECT_URI" ' 
{
  "authorization_policy": "one_factor",
  "client_id": $id,
  "client_name": $name,
  "client_password": $password,
  "client_secret": $secret,
  "pkce_challenge_method": "S256",
  "public": false,
  "redirect_uris": [$redirect],
  "require_pkce": true,
  "scopes": ["openid"]
}' | tee oidc-client.json
```

> \[!NOTE]
> `client_password` contains the client secret in plain text used by the application to authenticate with Authelia, while `client_secret` corresponds to the hash of this secret that Authelia stores and verifies.

## Step 2 — Create the secret and its metadata in Vault

The generated JSON is stored in Vault directly as a JSON object. The `bao kv put @<file>` command allows storing the complete JSON structure.

```bash
VAULT_MOUNT="${CLUSTER}"  # Adapt according to environment
VAULT_PATH="${APP}/auth/oidc-client"

# Store the JSON object directly in Vault
bao kv put -mount="$VAULT_MOUNT" "$VAULT_PATH" @oidc-client.json

# Add metadata for traceability
bao kv metadata put -mount="$VAULT_MOUNT" \
  -custom-metadata description="OIDC client configuration for ${APP}" \
  -custom-metadata origin="manual (following the SEC-20250808-00 procedure)" \
  -custom-metadata owner="authelia" \
  "$VAULT_PATH"

# Clean up temporary file
rm oidc-client.json
```

## Step 3 — Add the entry in `authelia-oidc.externalsecret.yaml`

Modify the file `projects/<cluster>/src/apps/*sso/authelia/authelia-oidc.externalsecret.yaml`. The template mechanism of this `ExternalSecret` will handle transforming the JSON object from Vault into a valid configuration for Authelia.

Example addition:

```yaml
# <App> OIDC client
- secretKey: oidc.client.<app_slug>
  remoteRef:
    key: <cluster>/<app>/auth/oidc-client
```

## Step 4 — Add the client reference in `authelia.yaml`

Modify Authelia's main configuration (`.../authelia/configurations/authelia.yaml`), inserting the reference to the new client while maintaining alphabetical order.

```yaml
- {{ secret "/var/run/secrets/authelia.com/authelia-oidc/oidc.client.<app_slug>" | nindent 8 }}
```

## Step 5 — Create the `SecurityPolicy` and `ExternalSecret`

Create a single file `security/<httproute>.securitypolicy.yaml` containing both Kubernetes resources.

**`SecurityPolicy` and `ExternalSecret`**
The `ExternalSecret` reads the JSON object from Vault and extracts the `client_password` property to provide it to the `SecurityPolicy`.

```yaml
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    security.chezmoi.sh/description: OIDC authentication policy for <httproute>
  name: <httproute>-oidc
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: <httproute>
  oidc:
    provider:
      issuer: https://auth.chezmoi.sh
    clientID: <client_id>
    clientSecret:
      name: <app>-oidc-secret
    redirectURL: https://<hostname>/oauth2/callback
    logoutPath: /logout
    forwardAccessToken: true
    scopes: [openid]
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: <app>-oidc-secret
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: <app>-oidc-secret
    creationPolicy: Owner
    template:
      data:
        client-secret: "{{ .client_password }}"
  data:
    - secretKey: client_password
      remoteRef:
        key: <cluster>/<app>/auth/oidc-client
        property: client_password
```

> \[!NOTE]
> The `security.chezmoi.sh/description` annotation is used for documentation. It should contain all the necessary information to understand the purpose of the `SecurityPolicy`.
> For example:
>
> * Are there additional scopes? If so, which ones and why?
> * Is there a specific configuration for any field and why?
> * Why use `one_factor` instead of `two_factor`?
> * etc...

***

## Complete Example: `home-dashboard` Application

This section provides a complete, concrete example of implementing OIDC authentication for the `home-dashboard` application on the `amiya.akn` cluster.

### Existing HTTPRoute

The home-dashboard application has the following HTTPRoute configuration:

```yaml
# projects/amiya.akn/src/apps/home-dashboard/home-dashboard.httproute.yaml
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/include-unifi: "true"
    link.argocd.argoproj.io/external-link: https://home.chezmoi.sh
  name: home-dashboard
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-default
      namespace: envoy-gateway-system
      sectionName: chezmoi.sh-websecure
  hostnames:
    - home.chezmoi.sh
  rules:
    - backendRefs:
        - group: ""
          kind: Service
          name: glance
          port: 80
          weight: 1
      matches:
        - path:
            type: PathPrefix
            value: /
```

### Step-by-step Implementation

#### 1. Generate the OIDC client JSON

```bash
# Inputs for home-dashboard
APP_DIR="projects/amiya.akn/src/apps/home-dashboard"
HTTPROUTE_FILE="projects/amiya.akn/src/apps/home-dashboard/home-dashboard.httproute.yaml"

# Derived values
CLUSTER="amiya.akn"
APP="home-dashboard"
HOSTNAME="home.chezmoi.sh"
REDIRECT_URI="https://home.chezmoi.sh/oauth2/callback"
CLIENT_ID="6fNbhb1c.ULGXogXtKfKdX40O"
CLIENT_NAME="home-dashboard"

# Generate secrets (example output)
CLIENT_PASSWORD="aB3dE7gH9jK2mN5pQ8rS1tU4vW6xY0zA"  # Generated password
CLIENT_SECRET="$pbkdf2-sha512$310000$..."           # Generated hash

# Generated OIDC client JSON
{
  "authorization_policy": "one_factor",
  "client_id": "home-dashboard",
  "client_name": "home-dashboard",
  "client_password": "aB3dE7gH9jK2mN5pQ8rS1tU4vW6xY0zA",
  "client_secret": "$pbkdf2-sha512$310000$...",
  "pkce_challenge_method": "S256",
  "public": false,
  "redirect_uris": ["https://home.chezmoi.sh/oauth2/callback"],
  "require_pkce": true,
  "scopes": ["openid"]
}
```

#### 2. Store in Vault

```bash
# Vault storage
VAULT_MOUNT="kv"
VAULT_PATH="amiya.akn/home-dashboard/auth/oidc-client"

bao kv put -mount="kv" "amiya.akn/home-dashboard/auth/oidc-client" @oidc-client.json
bao kv metadata put -mount="kv" \
  -custom-metadata description="OIDC client configuration for home-dashboard" \
  -custom-metadata origin="manual (following the SEC-20250808-00 procedure)" \
  -custom-metadata owner="authelia" \
  "amiya.akn/home-dashboard/auth/oidc-client"
```

#### 3. Update Authelia ExternalSecret

Add to `projects/amiya.akn/src/apps/sso/authelia/authelia-oidc.externalsecret.yaml`:

```yaml
# Home Dashboard OIDC client
- secretKey: oidc.client.home-dashboard
  remoteRef:
    key: amiya.akn/home-dashboard/auth/oidc-client
```

#### 4. Update Authelia Configuration

Add to `projects/amiya.akn/src/apps/sso/authelia/configurations/authelia.yaml` (in alphabetical order):

```yaml
clients:
  # ... existing clients ...
  - {{ secret "/var/run/secrets/authelia.com/authelia-oidc/oidc.client.home-dashboard" | nindent 8 }}
  # ... other clients ...
```

#### 5. Create SecurityPolicy and ExternalSecret

Create `projects/amiya.akn/src/apps/home-dashboard/security/home-dashboard.securitypolicy.yaml`:

```yaml
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  annotations:
    security.chezmoi.sh/description: |
      OIDC authentication policy for home-dashboard.
      Uses one_factor authentication as this is a personal dashboard with basic security requirements.
      Only requires openid scope for simple authentication without user information leakage.
  name: home-dashboard-oidc
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: home-dashboard
  oidc:
    provider:
      issuer: https://auth.chezmoi.sh
    clientID: home-dashboard
    clientSecret:
      name: home-dashboard-oidc-secret
    redirectURL: https://home.chezmoi.sh/oauth2/callback
    logoutPath: /logout
    forwardAccessToken: true
    scopes: [openid]
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: home-dashboard-oidc-secret
spec:
  secretStoreRef:
    name: vault.chezmoi.sh
    kind: ClusterSecretStore
  target:
    name: home-dashboard-oidc-secret
    creationPolicy: Owner
    template:
      data:
        client-secret: "{{ .client_password }}"
  data:
    - secretKey: client_password
      remoteRef:
        key: amiya.akn/home-dashboard/auth/oidc-client
        property: client_password
```

### Verification Commands

```bash
# Verify Vault storage
bao kv get -mount=kv amiya.akn/home-dashboard/auth/oidc-client | jq .

# Verify Kubernetes secret
kubectl -n home-dashboard get secret home-dashboard-oidc-secret -o yaml

# Verify SecurityPolicy
kubectl -n home-dashboard get securitypolicy home-dashboard-oidc

# Test user flow
curl -I https://home.chezmoi.sh
# Should return a 302 redirect to https://auth.chezmoi.sh/api/oidc/authorization/...
```

***

## Quick verifications

* **Vault**: `bao kv get -mount=kv <cluster>/<app>/auth/oidc-client | jq .`
* **Application secret**: `kubectl -n <namespace> get secret <app>-oidc-secret -o yaml` (verify that the `client-secret` key contains the password in plain text).
* **SecurityPolicy**: `kubectl -n <namespace> get securitypolicy <httproute>-oidc`.
* **User journey**: Access the application to trigger the OIDC redirect.

> \[!TIP]
> **Propagation delay**
> There may be a short delay (up to 5 minutes, depending on the `ExternalSecret` refresh interval) before changes are propagated through the system. If the flow fails immediately after applying changes, wait a moment before retesting.

***

<details>
<summary>Authelia OIDC client configuration options</summary>

| Name                                                             | Description                                         | Required | Default                          |
| ---------------------------------------------------------------- | --------------------------------------------------- | -------- | -------------------------------- |
| **client\_id**                                                   | Unique OIDC client identifier (≤100 chars, RFC3986) | ✅        | *generated*                      |
| **client\_name**                                                 | Name displayed to the user                          | ✅        |                                  |
| **client\_secret**                                               | Shared secret between Authelia and the application  | ✅        | *generated*                      |
| **redirect\_uris**                                               | Authorized redirect URLs                            | ✅        | *calculated from domain*         |
| **authorization\_policy**                                        | Required authentication level                       | ✅        | `two_factor`                     |
| **public**                                                       | Public client (SPA/CLI) or confidential             | ❌        | `false`                          |
| **scopes**                                                       | Scopes requested by the client                      | ❌        | `["openid", "profile", "email"]` |
| **grant\_types**                                                 | Authorized grant types                              | ❌        | `["authorization_code"]`         |
| **response\_types**                                              | Supported response types                            | ❌        | `["code"]`                       |
| **response\_modes**                                              | Supported response modes                            | ❌        | `["form_post", "query"]`         |
| **audience**                                                     | Authorized audiences for this client                | ❌        | `[]`                             |
| **sector\_identifier\_uri**                                      | URI to identify pairwise (privacy)                  | ❌        | `""`                             |
| **request\_uris**                                                | URIs for Request Objects JWT                        | ❌        | `[]`                             |
| **lifespan**                                                     | Custom lifespan name                                | ❌        | `""`                             |
| **claims\_policy**                                               | Custom claims policy name                           | ❌        | `""`                             |
| **requested\_audience\_mode**                                    | Audience management mode                            | ❌        | `explicit`                       |
| **consent\_mode**                                                | User consent mode                                   | ❌        | `auto`                           |
| **pre\_configured\_consent\_duration**                           | Consent memorization duration                       | ❌        | `1 week`                         |
| **require\_pushed\_authorization\_requests**                     | Force PAR usage                                     | ❌        | `false`                          |
| **require\_pkce**                                                | Force PKCE usage                                    | ❌        | `false`                          |
| **pkce\_challenge\_method**                                      | PKCE method (S256 recommended)                      | ❌        | `""`                             |
| **token\_endpoint\_auth\_method**                                | Auth method at token endpoint                       | ❌        | `client_secret_basic`            |
| **token\_endpoint\_auth\_signing\_alg**                          | Signature algorithm for JWT auth                    | ❌        | `RS256`                          |
| **revocation\_endpoint\_auth\_method**                           | Auth method at revocation endpoint                  | ❌        | `client_secret_basic`            |
| **revocation\_endpoint\_auth\_signing\_alg**                     | Signature algorithm for revocation                  | ❌        | `RS256`                          |
| **introspection\_endpoint\_auth\_method**                        | Auth method at introspection endpoint               | ❌        | `client_secret_basic`            |
| **introspection\_endpoint\_auth\_signing\_alg**                  | Signature algorithm for introspection               | ❌        | `RS256`                          |
| **pushed\_authorization\_request\_endpoint\_auth\_method**       | Auth method for PAR                                 | ❌        | `client_secret_basic`            |
| **pushed\_authorization\_request\_endpoint\_auth\_signing\_alg** | Signature algorithm for PAR                         | ❌        | `RS256`                          |
| **jwks\_uri**                                                    | JWK public keys URI                                 | ❌        | `""`                             |
| **jwks**                                                         | Manual JWK public keys                              | ❌        | `[]`                             |
| **request\_object\_signing\_alg**                                | Request Objects signature algorithm                 | ❌        | `RS256`                          |
| **request\_object\_encryption\_alg**                             | Request Objects encryption algorithm                | ❌        | `""`                             |
| **request\_object\_encryption\_enc**                             | Request Objects encrypted content algorithm         | ❌        | `""`                             |

</details>

## References

* **Authelia OIDC Clients**: [Configuration Schema](https://www.authelia.com/configuration/identity-providers/openid-connect/clients/)
* **Best practices for writing**: [QualityHub SOP Guidelines](https://qualityhub.com/resources/guidelines-for-writing-effective-standard-operation-procedures/), [MadCap Best Practices](https://www.madcapsoftware.com/blog/best-practices-for-writing-policies-and-procedures/)

## History

* *2025-08-08*: Initial creation of security policy for HTTP route.
* *2025-08-09*: Rename `sso.chezmoi.sh` to `auth.chezmoi.sh`
